var collie=collie||{};!function(){collie.version="1.1.1",collie.Class=function(a,b){var c,d=null,e=function(){return!0};if("$init"in a&&(d=a.$init,delete a.$init),"undefined"==typeof b)c=function(){var a=arguments;return this instanceof c?(a.length&&a[0]===e&&(a=a[1]),null!==d&&d.apply(this,a),void 0):new c(e,a)};else{c=function(){var a=arguments;return this instanceof c?(a.length&&a[0]===e&&(a=a[1]),b.apply(this,a),null!==d&&d.apply(this,a),void 0):new c(e,a)};var f=function(){};f.prototype=b.prototype,c.$super=b.prototype,c.prototype=new f,c.prototype.constructor=c}for(var g in a)a.hasOwnProperty(g)&&"prototype"!==g&&(c.prototype[g]=a[g]);return c},collie.util=new(collie.Class({$init:function(){this._sCSSPrefix=null,this._htDeviceInfo=null,this._bSupport3d=null,this._bSupportCSS3=null,this._htBoundary={left:0,right:0,top:0,bottom:0}},getDisplayObjectById:function(a){return collie.DisplayObject.htFactory[a]},getDisplayObjectByName:function(a){for(var b in collie.DisplayObject.htFactory)if(collie.DisplayObject.htFactory[b].get("name")===a)return collie.DisplayObject.htFactory[b];return!1},getDeviceInfo:function(a){if(null!==this._htDeviceInfo&&"undefined"==typeof a)return this._htDeviceInfo;var b=null,c=!1,d="undefined"!=typeof CanvasRenderingContext2D,e=!1,f=!1,g=!1,h=/chrome/i.test(a)?!0:!1,a=a||navigator.userAgent,i=0;return/android/i.test(a)?(e=!0,b=a.toString().match(/android ([0-9]\.[0-9])\.?([0-9]?)/i),b&&b[1]&&(i=(parseFloat(b[1])+(b[2]?.01*b[2]:0)).toFixed(2))):/(iphone|ipad|ipod)/i.test(a)?(f=!0,b=a.toString().match(/([0-9]_[0-9])/i),b&&b[1]&&(i=parseFloat(b[1].replace(/_/,".")))):(c=!0,/(MSIE)/i.test(a)&&(g=!0,b=a.toString().match(/MSIE ([0-9])/i),b&&b[1]&&(i=parseInt(b[1],10)))),this._htDeviceInfo={supportCanvas:d,desktop:c,android:e?i:!1,ios:f?i:!1,ie:g?i:!1,chrome:h},this._htDeviceInfo},getCSSPrefix:function(a,b){var c="";if(null===this._sCSSPrefix&&(this._sCSSPrefix="","undefined"!=typeof document.body.style.webkitTransform?this._sCSSPrefix="-webkit-":"undefined"!=typeof document.body.style.MozTransform?this._sCSSPrefix="-moz-":"undefined"!=typeof document.body.style.OTransform?this._sCSSPrefix="-o-":"undefined"!=typeof document.body.style.msTransform&&(this._sCSSPrefix="-ms-")),c=this._sCSSPrefix+(a?a:""),b){var d=c.split("-");c="";for(var e=0,f=d.length;f>e;e++)d[e]&&(c+=c?d[e].substr(0,1).toUpperCase()+d[e].substr(1):d[e]);("-moz-"===this._sCSSPrefix||"-o-"===this._sCSSPrefix)&&(c=c.substr(0,1).toUpperCase()+c.substr(1))}return c},getSupportCSS3:function(){return null===this._bSupportCSS3&&(this._bSupportCSS3="undefined"!=typeof document.body.style[collie.util.getCSSPrefix("transform",!0)]||"undefined"!=typeof document.body.style.transform),this._bSupportCSS3},getSupportCSS3d:function(){return null===this._bSupport3d&&(this._bSupport3d=("undefined"!=typeof document.body.style[collie.util.getCSSPrefix("perspective",!0)]||"undefined"!=typeof document.body.style.perspective)&&(!collie.util.getDeviceInfo().android||collie.util.getDeviceInfo().android>=4)),this._bSupport3d},toRad:function(a){return a*Math.PI/180},toDeg:function(a){return 180*a/Math.PI},approximateValue:function(a){return Math.round(1e7*a)/1e7},fixAngle:function(a){var b=collie.util.toDeg(a);return b-=360*Math.floor(b/360),collie.util.toRad(b)},getDistance:function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))},getBoundary:function(a){for(var b=a[0][0],c=a[0][0],d=a[0][1],e=a[0][1],f=1,g=a.length;g>f;f++)b=Math.min(b,a[f][0]),c=Math.max(c,a[f][0]),d=Math.min(d,a[f][1]),e=Math.max(e,a[f][1]);return{left:b,right:c,top:d,bottom:e}},getBoundaryToPoints:function(a){return[[a.left,a.top],[a.right,a.top],[a.right,a.bottom],[a.left,a.bottom]]},queryString:function(){var a={};if(location.search)for(var b=location.search.substr(1).split("&"),c=0,d=b.length;d>c;c++){var e=b[c].split("=");a[e.shift()]=e.join("=")}return a},cloneObject:function(a){var b={};for(var c in a)b[c]=a[c];return b},pushWithSort:function(a,b){for(var c=!1,d=0,e=a.length;e>d;d++)if(a[d]._htOption.zIndex>b._htOption.zIndex){a.splice(d,0,b),c=!0;break}c||a.push(b)},addEventListener:function(a,b,c,d){"string"==typeof a&&(a=document.getElementById(a)),"addEventListener"in a?a.addEventListener(b,c,d):a.attachEvent("on"+b,c,d)},removeEventListener:function(a,b,c,d){"string"==typeof a&&(a=document.getElementById(a)),"removeEventListener"in a?a.removeEventListener(b,c,d):a.detachEvent("on"+b,c,d)},stopEventDefault:function(a){a=a||window.event,"preventDefault"in a&&a.preventDefault(),a.returnValue=!1},getPosition:function(a){"string"==typeof a&&(a=document.getElementById(a));var b=a.ownerDocument||a.document||document,c=b.documentElement,d=b.body,e={};if("getBoundingClientRect"in a){var f=a.getBoundingClientRect();e.x=f.left,e.x+=c.scrollLeft||d.scrollLeft,e.y=f.top,e.y+=c.scrollTop||d.scrollTop,e.width=f.width,e.height=f.height}else{e.x=0,e.y=0,e.width=a.offsetWidth,e.height=a.offsetHeight;for(var g=a;g;g=g.offsetParent)e.x+=g.offsetLeft,e.y+=g.offsetTop;for(var g=a.parentNode;g&&"BODY"!==g.tagName;g=g.parentNode)"TR"===g.tagName&&(e.y+=2),e.x-=g.scrollLeft,e.y-=g.scrollTop}return e}})),collie.util.getDeviceInfo().ios&&window.addEventListener("load",function(){setTimeout(function(){document.body.scrollTop=0},300)}),Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var a=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;a&&a.lineTo&&(a._dashedLineProperty={index:0,length:0},a.resetDashedLine=function(){this._dashedLineProperty={index:0,length:0}},a.dashedLine=function(a,b,c,d,e,f){e||(e=[10,5]);for(var g=c-a,h=d-b,i=Math.sqrt(g*g+h*h),j=Math.atan2(h,g),k=e.length,l=this._dashedLineProperty.index||0,m=this._dashedLineProperty.length||0,n=0,o=0;i>m;)(0!==n||0===m)&&(m+=e[l++%k]*f),m>i&&(this._dashedLineProperty.length=m-i,m=i),n=a+m*Math.cos(j),o=b+m*Math.sin(j),l%2===1?this.lineTo(n,o):this.moveTo(n,o);this._dashedLineProperty.index=l}),collie.raphaelDashArray={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]}}(),collie.Effect=function(a){if(this instanceof arguments.callee)throw new Error("You can't create a instance of this");var b=/^(\-?[0-9\.]+)(%|px|pt|em)?$/,c=/^rgb\(([0-9]+)\s?,\s?([0-9]+)\s?,\s?([0-9]+)\)$/i,d=/^#([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})$/i,e=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i,f=function(a){var f,g=a;return b.test(a)?(g=parseFloat(a),f=RegExp.$2||""):c.test(a)?(g=[parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)],f="color"):d.test(a=a.replace(e,"#$1$1$2$2$3$3"))&&(g=[parseInt(RegExp.$1,16),parseInt(RegExp.$2,16),parseInt(RegExp.$3,16)],f="color"),{nValue:g,sUnit:f}};return function(b,c){var d;if(arguments.length>1?(b=f(b),c=f(c),d=c.sUnit):(c=f(b),b=null,d=c.sUnit),b&&c&&b.sUnit!=c.sUnit)throw new Error("unit error");b=b&&b.nValue,c=c&&c.nValue;var e=function(e){var f=a(e),g=function(a,b){return(b-a)*f+a+d};if("color"==d){var h=Math.max(0,Math.min(255,parseInt(g(b[0],c[0]),10)))<<16;h|=Math.max(0,Math.min(255,parseInt(g(b[1],c[1]),10)))<<8,h|=Math.max(0,Math.min(255,parseInt(g(b[2],c[2]),10))),h=h.toString(16).toUpperCase();for(var i=0;6-h.length;i++)h="0"+h;return"#"+h}return g(b,c)};return null===b&&(e.setStart=function(a){if(a=f(a),a.sUnit!=d)throw new Error("unit eror");b=a.nValue}),e}},collie.Effect.linear=collie.Effect(function(a){return a}),collie.Effect.easeInSine=collie.Effect(function(a){return 1==a?1:-Math.cos(a*(Math.PI/2))+1}),collie.Effect.easeOutSine=collie.Effect(function(a){return Math.sin(a*(Math.PI/2))}),collie.Effect.easeInOutSine=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInSine(0,1)(2*a):.5*collie.Effect.easeOutSine(0,1)(2*a-1)+.5}),collie.Effect.easeOutInSine=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutSine(0,1)(2*a):.5*collie.Effect.easeInSine(0,1)(2*a-1)+.5}),collie.Effect.easeInQuad=collie.Effect(function(a){return a*a}),collie.Effect.easeOutQuad=collie.Effect(function(a){return-(a*(a-2))}),collie.Effect.easeInOutQuad=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInQuad(0,1)(2*a):.5*collie.Effect.easeOutQuad(0,1)(2*a-1)+.5}),collie.Effect.easeOutInQuad=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutQuad(0,1)(2*a):.5*collie.Effect.easeInQuad(0,1)(2*a-1)+.5}),collie.Effect.easeInCubic=collie.Effect(function(a){return Math.pow(a,3)}),collie.Effect.easeOutCubic=collie.Effect(function(a){return Math.pow(a-1,3)+1}),collie.Effect.easeInOutCubic=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeIn(0,1)(2*a):.5*collie.Effect.easeOut(0,1)(2*a-1)+.5}),collie.Effect.easeOutInCubic=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOut(0,1)(2*a):.5*collie.Effect.easeIn(0,1)(2*a-1)+.5}),collie.Effect.easeInQuart=collie.Effect(function(a){return Math.pow(a,4)}),collie.Effect.easeOutQuart=collie.Effect(function(a){return-(Math.pow(a-1,4)-1)}),collie.Effect.easeInOutQuart=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInQuart(0,1)(2*a):.5*collie.Effect.easeOutQuart(0,1)(2*a-1)+.5}),collie.Effect.easeOutInQuart=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutQuart(0,1)(2*a):.5*collie.Effect.easeInQuart(0,1)(2*a-1)+.5}),collie.Effect.easeInQuint=collie.Effect(function(a){return Math.pow(a,5)}),collie.Effect.easeOutQuint=collie.Effect(function(a){return Math.pow(a-1,5)+1}),collie.Effect.easeInOutQuint=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInQuint(0,1)(2*a):.5*collie.Effect.easeOutQuint(0,1)(2*a-1)+.5}),collie.Effect.easeOutInQuint=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutQuint(0,1)(2*a):.5*collie.Effect.easeInQuint(0,1)(2*a-1)+.5}),collie.Effect.easeInCircle=collie.Effect(function(a){return-(Math.sqrt(1-a*a)-1)}),collie.Effect.easeOutCircle=collie.Effect(function(a){return Math.sqrt(1-(a-1)*(a-1))}),collie.Effect.easeInOutCircle=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInCircle(0,1)(2*a):.5*collie.Effect.easeOutCircle(0,1)(2*a-1)+.5}),collie.Effect.easeOutInCircle=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutCircle(0,1)(2*a):.5*collie.Effect.easeInCircle(0,1)(2*a-1)+.5}),collie.Effect.easeInBack=collie.Effect(function(a){var b=1.70158;return 1==a?1:a/1*(a/1)*((1+b)*a-b)}),collie.Effect.easeOutBack=collie.Effect(function(a){var b=1.70158;return 0===a?0:(a=a/1-1)*a*((b+1)*a+b)+1}),collie.Effect.easeInOutBack=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInBack(0,1)(2*a):.5*collie.Effect.easeOutBack(0,1)(2*a-1)+.5}),collie.Effect.easeInElastic=collie.Effect(function(a){var b,c=0,d=0;return 0===a?0:1==(a/=1)?1:(c||(c=.3),!d||1>d?(d=1,b=c/4):b=c/(2*Math.PI)*Math.asin(1/d),-(d*Math.pow(2,10*(a-=1))*Math.sin(2*(a-1)*Math.PI/c)))}),collie.Effect.easeOutElastic=collie.Effect(function(a){var b,c=0,d=0;return 0===a?0:1==(a/=1)?1:(c||(c=.3),!d||1>d?(d=1,b=c/4):b=c/(2*Math.PI)*Math.asin(1/d),d*Math.pow(2,-10*a)*Math.sin(2*(a-b)*Math.PI/c)+1)}),collie.Effect.easeInOutElastic=collie.Effect(function(a){var b,c=0,d=0;return 0===a?0:2==(a/=.5)?1:(c||(c=.3*1.5),!d||1>d?(d=1,b=c/4):b=c/(2*Math.PI)*Math.asin(1/d),1>a?-.5*d*Math.pow(2,10*(a-=1))*Math.sin(2*(a-b)*Math.PI/c):d*Math.pow(2,-10*(a-=1))*Math.sin(2*(a-b)*Math.PI/c)*.5+1)}),collie.Effect.easeOutBounce=collie.Effect(function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375}),collie.Effect.easeInBounce=collie.Effect(function(a){return 1-collie.Effect.easeOutBounce(0,1)(1-a)}),collie.Effect.easeInOutBounce=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInBounce(0,1)(2*a):.5*collie.Effect.easeOutBounce(0,1)(2*a-1)+.5}),collie.Effect.easeInExpo=collie.Effect(function(a){return 0===a?0:Math.pow(2,10*(a-1))}),collie.Effect.easeOutExpo=collie.Effect(function(a){return 1==a?1:-Math.pow(2,-10*a/1)+1}),collie.Effect.easeInOutExpo=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeInExpo(0,1)(2*a):.5*collie.Effect.easeOutExpo(0,1)(2*a-1)+.5}),collie.Effect.easeOutInExpo=collie.Effect(function(a){return.5>a?.5*collie.Effect.easeOutExpo(0,1)(2*a):.5*collie.Effect.easeInExpo(0,1)(2*a-1)+.5}),collie.Effect._cubicBezier=function(a,b,c,d){return function(e){function f(a){return((l*a+k)*a+j)*a}function g(a){return((o*a+n)*a+m)*a}function h(a){return(3*l*a+2*k)*a+j}function i(a,b){var c,d,e,g,i,j;for(e=a,j=0;8>j;j++){if(g=f(e)-a,Math.abs(g)<b)return e;if(i=h(e),Math.abs(i)<1e-6)break;e-=g/i}if(c=0,d=1,e=a,c>e)return c;if(e>d)return d;for(;d>c;){if(g=f(e),Math.abs(g-a)<b)return e;a>g?c=e:d=e,e=.5*(d-c)+c}return e}var j=3*a,k=3*(c-a)-j,l=1-j-k,m=3*b,n=3*(d-b)-m,o=1-m-n;return g(i(e,.005))}},collie.Effect.cubicBezier=function(a,b,c,d){return collie.Effect(collie.Effect._cubicBezier(a,b,c,d))},collie.Effect.cubicEase=collie.Effect.cubicBezier(.25,.1,.25,1),collie.Effect.cubicEaseIn=collie.Effect.cubicBezier(.42,0,1,1),collie.Effect.cubicEaseOut=collie.Effect.cubicBezier(0,0,.58,1),collie.Effect.cubicEaseInOut=collie.Effect.cubicBezier(.42,0,.58,1),collie.Effect.cubicEaseOutIn=collie.Effect.cubicBezier(0,.42,1,.58),collie.Effect.overphase=collie.Effect(function(a){return a/=.652785,(Math.sqrt((2-a)*a)+.1*a).toFixed(5)}),collie.Effect.sinusoidal=collie.Effect(function(a){return-Math.cos(a*Math.PI)/2+.5}),collie.Effect.mirror=collie.Effect(function(a){return.5>a?collie.Effect.sinusoidal(0,1)(2*a):collie.Effect.sinusoidal(0,1)(1-2*(a-.5))}),collie.Effect.pulse=function(a){return collie.Effect(function(b){return-Math.cos(b*(a-.5)*2*Math.PI)/2+.5})},collie.Effect.wave=function(a,b){return collie.Effect(function(c){return(b||1)*Math.sin(360*a*c*Math.PI/180).toFixed(5)})},collie.Effect.easeIn=collie.Effect.easeInCubic,collie.Effect.easeOut=collie.Effect.easeOutCubic,collie.Effect.easeInOut=collie.Effect.easeInOutCubic,collie.Effect.easeOutIn=collie.Effect.easeOutInCubic,collie.Effect.bounce=collie.Effect.easeOutBounce,collie.Effect.elastic=collie.Effect.easeInElastic,collie.Component=collie.Class({$init:function(){this._bInitOption=!1,this._htOption={},this._htOptionSetter={},this._htHandler={}},option:function(a,b,c){if("object"==typeof a)if(this._bInitOption)for(var d in a)this.option(d,a[d],c);else this._htOption=collie.util.cloneObject(a),this._bInitOption=!0;else{if("string"!=typeof a)return this._htOption;if(void 0===b)return this._htOption[a];c&&"undefined"!=typeof this._htOption[a]||(this._htOption[a]=b,void 0!==this._htOptionSetter[a]&&this._htOptionSetter[a](b),this._bInitOption=!0)}},get:function(a){return this.option(a)},set:function(a,b,c){return this.option(a,b,c),this},unset:function(a){this._htOption&&"undefined"!=typeof this._htOption[a]&&delete this._htOption[a]},optionSetter:function(a,b){this._htOptionSetter[a]=b},fireEvent:function(a,b){if("undefined"!=typeof this._htHandler[a]&&this._htHandler[a].length>0){b=b||{},oCustomEvent=new collie.ComponentEvent(a,b);for(var c=this._htHandler[a].concat(),d=!1,e=0,f=c.length;f>e;e++)this._htHandler[a][e](oCustomEvent),oCustomEvent.isStop()&&(d=!0);if(d)return!1}return!0},attach:function(a,b){if("string"!=typeof a)for(var c in a)this.attach(c,a[c]);else{this._htHandler[a]=this._htHandler[a]||[];var d=this._htHandler[a];if(!b)return this;for(var c=0,e=d.length;e>c;c++)if(d[c]===b)return this;d.push(b)}return this},detach:function(a,b){if("string"!=typeof a)for(var c in a)this.detach(c,a[c]);else if(void 0!==this._htHandler[a]){var d=this._htHandler[a];if(b){for(var c=0,e=d.length;e>c;c++)if(d[c]===b){this._htHandler[a].splice(c,1),this._htHandler[a].length<1&&delete this._htHandler[a];break}}else delete this._htHandler[a]}},detachAll:function(a){a?void 0!==this._htHandler[a]&&(this._htHandler[a]=[]):this._htHandler={}}}),collie.ComponentEvent=collie.Class({$init:function(a,b){if(this.type=a,this._bCanceled=!1,b)for(var c in b)this[c]=b[c]},stop:function(){this._bCanceled=!0},isStop:function(){return this._bCanceled}}),collie.SpriteSheet=collie.Class({$init:function(){this._htSpriteSheet={}},add:function(a,b,c,d,e,f,g){if("object"==typeof b)if(b instanceof Array)for(var h=0,i=b.length;i>h;h++)this.add.apply(this,[a,h].concat(b[h]));else for(var h in b)this.add.apply(this,[a,h].concat(b[h]));else this._htSpriteSheet[a]=this._htSpriteSheet[a]||{},"undefined"!=typeof e?collie.ImageManager.getImage(a,function(h){this._addWithSpriteLength(h,a,b,c,d,e,f,g)}.bind(this)):this._htSpriteSheet[a][b]=[c,d]},_addWithSpriteLength:function(a,b,c,d,e,f,g,h){var j=this._htSpriteSheet[b][c]=[],k=a.width,l=a.height;collie.Renderer.isRetinaDisplay()&&(k/=2,l/=2);var m=d,n=e;for(i=0;h>i&&(m>=k&&(m=0,n+=g),!(n>=l));i++)j.push([m,n]),m+=f},remove:function(a){this._htSpriteSheet[a]&&delete this._htSpriteSheet[a]},get:function(a){return this._htSpriteSheet[a]?this._htSpriteSheet[a]:!1},reset:function(){this._htSpriteSheet={}}}),collie.ImageManager=collie.ImageManager||new(collie.Class({RETRY_COUNT:3,RETRY_DELAY:500,USE_PRERENDERING_DOM:!1,$init:function(){this._aImages=[],this._htImageNames={},this._htImageRetryCount={},this._htImageWhileLoading={},this._nCount=0,this._oSpriteSheet=new collie.SpriteSheet},_addImage:function(a,b){var c=this._aImages.push({element:a,name:b}),d=this._htImageNames[b];if(this._htImageNames[b]=c-1,delete this._htImageRetryCount[b],d&&d instanceof Array){for(var e=0,f=d.length;f>e;e++)d[e](a,b);d=null}this.fireEvent("process",{name:b,url:a.src,count:c,total:this._nCount,ratio:Math.round(c/this._nCount*1e3)/1e3}),this._nCount===c&&this.fireEvent("complete")},_markImage:function(a){this._htImageNames[a]||(this._htImageNames[a]=[]),this._htImageRetryCount[a]||(this._htImageRetryCount[a]=0)},_makeHash:function(){this._htImageNames={};for(var a=0,b=this._aImages.length;b>a;a++)this._htImageNames[this._aImages[a].name]=a},getImage:function(a,b){return a||0===a?(a in this._htImageNames||this._markImage(a),this._htImageNames[a]instanceof Array?b&&this._addMarkCallback(a,b):b?(b(this._aImages[this._htImageNames[a]].element),void 0):this._aImages[this._htImageNames[a]].element):!1},_addMarkCallback:function(a,b,c){if(a in this._htImageNames&&this._htImageNames[a]instanceof Array){if(c){var d=function e(b){b.name===a&&(c(),this.detach("error",e))};this.attach("error",d)}return b&&this._htImageNames[a].push(b),!0}return!1},removeImage:function(a){if(!(a in this._htImageNames))return!1;var b=this._aImages.splice(this._htImageNames[a],1);this._makeHash(),b.onload=null,b.onerror=null,b.src=null,b=null,this._oSpriteSheet.remove(a)},remove:function(a){this.removeImage(a)},add:function(){"object"==typeof arguments[0]?this.addImages.apply(this,arguments):this.addImage.apply(this,arguments)},addImages:function(a,b,c){var d=null,e=null,f=0,g=0,h=[];for(var i in a)f++;b&&null!==b&&(d=function(){g++,g>=f&&b(a)}.bind(this)),c&&null!==c&&(e=function(a,b,d){h.push([a,b,d]),h.length+g>=f&&c(h)}.bind(this));for(var i in a)this.addImage(i,a[i],d,e)},addImage:function(a,b,c,d){if(this.getImage(a))return c&&null!==c&&c(this.getImage(a),a,b),void 0;if(!(a in this._htImageWhileLoading&&this._addMarkCallback(a,c,d))){this._nCount++,this._markImage(a);var e=new Image;this.USE_PRERENDERING_DOM&&"dom"===collie.Renderer.getRenderingMode()&&collie.util.getSupportCSS3d()&&!collie.util.getDeviceInfo().android&&(e.style.webkitTransform="translateZ(0)",e.style.position="absolute",e.style.visibility="hidden",collie.Renderer.getElement().appendChild(e)),this._htImageWhileLoading[a]=e,e.onload=function(){this._addImage(e,a),c&&null!==c&&c(e,a,b),e.onerror=e.onload=null,this._deleteWhileLoading(a)}.bind(this),e.onerror=function(){return this._htImageRetryCount[a]<this.RETRY_COUNT?(this._htImageRetryCount[a]++,this.fireEvent("retry",{count:this._aImages.length,total:this._nCount,name:a,url:b,delay:this.RETRY_DELAY,retryCount:this._htImageRetryCount[a]}),setTimeout(function(){e.src="about:blank",e.src=b},this.RETRY_DELAY),void 0):(d&&null!==d&&d(e,a,b),this.fireEvent("error",{count:this._aImages.length,total:this._nCount,name:a,url:b}),e.onerror=e.onload=null,this._deleteWhileLoading(a),void 0)}.bind(this),e.src=b}},_deleteWhileLoading:function(a){delete this._htImageWhileLoading[a]},abort:function(){for(var a in this._htImageWhileLoading)this._htImageWhileLoading[a].onload=this._htImageWhileLoading[a].onerror=null,this._htImageWhileLoading[a].src=null,this._htImageWhileLoading[a]=null;this._htImageWhileLoading={},this._htImageStartedLoading={}},reset:function(){this.abort(),this._aImages=[],this._htImageNames={},this._htImageRetryCount={},this._htImageWhileLoading={},this._nCount=0,this._oSpriteSheet.reset()},cancelGetImage:function(a,b){if(this._htImageNames[a]instanceof Array)for(var c=0,d=this._htImageNames[a].length;d>c;c++)if(this._htImageNames[a][c]===b)return this._htImageNames[a].splice(c,1),void 0},addSprite:function(a,b,c,d){this._oSpriteSheet.add(a,b,c,d)},getSprite:function(a){return this._oSpriteSheet.get(a)},removeSprite:function(a){this._oSpriteSheet.remove(a)}},collie.Component)),collie.Matrix={multiple:function(a,b){for(var c=[],d=0,e=b.length;e>d;d++){for(var f=[],g=0,h=b[0].length;h>g;g++){for(var i=0,j=0,k=a[0].length;k>j;j++)i+=a[d][j]*b[j][g];f.push(i)}c.push(f)}return c},translate:function(a,b){return[[1,0,a],[0,1,b],[0,0,1]]},scale:function(a,b){return[[a,0,0],[0,b,0],[0,0,1]]},rotate:function(a){var b=collie.util.toRad(a),c=Math.cos(b),d=Math.sin(b);return[[c,-d,0],[d,c,0],[0,0,1]]},transform:function(a,b,c){var d=this.multiple(a,[[b],[c],[1]]);return{x:d[0][0],y:d[1][0]}}},collie.Transform={_htBoundary:{left:0,top:0,right:0,bottom:0},_bIsIEUnder8:collie.util.getDeviceInfo().ie&&collie.util.getDeviceInfo().ie<9,getBoundary:function(a,b){var c=a.get(),d=[[0,0],[c.width,0],[c.width,c.height],[0,c.height]],e=this.points(a,d),f=collie.util.getBoundary(e);return this._htBoundary.left=f.left,this._htBoundary.right=f.right,this._htBoundary.bottom=f.bottom,this._htBoundary.top=f.top,this._htBoundary.isTransform=this.isUseTransform(a),b&&(this._htBoundary.points=e),this._htBoundary},points:function(a,b){var c;if(this._bIsIEUnder8||(c=this.getMatrixRecusively(a)),!c)return b;for(var d=[],e=0,f=b.length;f>e;e++){var g=collie.Matrix.transform(c,b[e][0],b[e][1]);d.push([g.x,g.y])}return d},getMatrixRecusively:function(a){for(var b=a,c=null,d=0,e=0;b;){if(this.isUseTransform(b)){var f=this.getMatrix(b,d,e);c=null!==c?collie.Matrix.multiple(c,f):f}d-=b._htOption.x,e-=b._htOption.y,b=b.getParent()}return c},getMatrix:function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0);var d=a.getOrigin(),e=a.get(),f=collie.Matrix.translate(d.x+b,d.y+c);return 0!==e.angle&&(f=collie.Matrix.multiple(f,collie.Matrix.rotate(e.angle))),(1!==e.scaleX||1!==e.scaleY)&&(f=collie.Matrix.multiple(f,collie.Matrix.scale(e.scaleX,e.scaleY))),f=collie.Matrix.multiple(f,collie.Matrix.translate(-(d.x+b),-(d.y+c)))},isUseTransform:function(a){return 1!==a._htOption.scaleX||1!==a._htOption.scaleY||0!==a._htOption.angle}},collie.LayerCanvas=collie.Class({$init:function(a){this._oLayer=a,this._oEvent=a.getEvent(),this._htDeviceInfo=collie.util.getDeviceInfo(),this._initCanvas()},_initCanvas:function(){var a=this._getLayerSize();this._elCanvas=document.createElement("canvas"),this._elCanvas.width=a.width,this._elCanvas.height=a.height,this._elCanvas.className="_collie_layer",this._elCanvas.style.position="absolute",this._elCanvas.style.left=this._oLayer.option("x")+"px",this._elCanvas.style.top=this._oLayer.option("y")+"px",collie.Renderer.isRetinaDisplay()&&(this._elCanvas.style.width=a.width/2+"px",this._elCanvas.style.height=a.height/2+"px"),this._oContext=this._elCanvas.getContext("2d")},_getLayerSize:function(a,b){return a=a||this._oLayer.option("width"),b=b||this._oLayer.option("height"),collie.Renderer.isRetinaDisplay()&&(a*=2,b*=2),{width:a,height:b}},getContext:function(){return this._oContext},getElement:function(){return this._elCanvas},clear:function(a){a=a||this.getContext(),!this._htDeviceInfo.android||this._htDeviceInfo.android<4.12&&this._htDeviceInfo.android>=4.2?a.clearRect(0,0,this._elCanvas.width+1,this._elCanvas.height+1):this._elCanvas.width=this._elCanvas.width},resize:function(a,b,c){var d=this._getLayerSize(a,b);if(c){this._elCanvas.style.width=a+"px",this._elCanvas.style.height=b+"px";var e=a/this._oLayer.option("width"),f=b/this._oLayer.option("height");this._oEvent.setEventRatio(e,f)}else{var g="number"==typeof a?d.width:this._elCanvas.width,h="number"==typeof b?d.height:this._elCanvas.height;this.clear(this._oContext),this._oLayer.setChanged(),this._elCanvas.width=g,this._elCanvas.height=h,collie.Renderer.isRetinaDisplay()&&(this._elCanvas.style.width=g/2+"px",this._elCanvas.style.height=h/2+"px")}}}),collie.LayerDOM=collie.Class({$init:function(a){this._oLayer=a,this._oEvent=a.getEvent(),this._htOption=a.option(),this._initElement(),this._rxDisplayObjectId=new RegExp(collie.DisplayObjectDOM.ID+"([0-9]+)")},_initElement:function(){this._el=document.createElement("div"),this._el.className="_collie_layer",this._el.style.position="absolute",this._el.style.left=this._htOption.x+"px",this._el.style.top=this._htOption.y+"px",this._el.style.width=this._htOption.width+"px",this._el.style.height=this._htOption.height+"px",this._el.style.overflow="hidden"},findDisplayObjectElement:function(a){for(;a&&1==a.nodeType;){if(this.isDisplayObjectElement(a)&&a.parentNode===this._el)return a;a=a.parentNode}return!1},isDisplayObjectElement:function(a){return"classList"in a?a.classList.contains(collie.DisplayObjectDOM.CLASSNAME):(" "+a.className+" ").indexOf(" "+collie.DisplayObjectDOM.CLASSNAME+" ")>-1},getElement:function(){return this._el},clear:function(){return!0},resize:function(a,b,c){if(c){var d=parseFloat(a/this._oLayer.option("width")).toFixed(2),e=parseFloat(b/this._oLayer.option("height")).toFixed(2);this._oEvent.setEventRatio(d,e),this._el.style[collie.util.getCSSPrefix("transform-origin",!0)]="0 0",collie.util.getSupportCSS3d()?this._el.style[collie.util.getCSSPrefix("transform",!0)]="scale3d("+d+", "+e+", 1)":collie.util.getSupportCSS3()?this._el.style[collie.util.getCSSPrefix("transform",!0)]="scale("+d+", "+e+")":this._el.style.filter="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand',M11="+d+",M12=0,M21=0,M22="+e+");"}else this._el.style.width=a+"px",this._el.style.height=b+"px"}}),collie.LayerEvent=collie.Class({THRESHOLD_CLICK:7,$init:function(a){this._oLayer=a,this._bHasTouchEvent=!!("ontouchstart"in window),this._fOnEvent=this._onEvent.bind(this),this._oMousedownObject=null,this._htEventRatio={width:1,height:1},this._bAttached=!1},attachEvent:function(){var a=this._oLayer.getParent();this._bHasTouchEvent?(collie.util.addEventListener(a,"touchstart",this._fOnEvent),collie.util.addEventListener(a,"touchend",this._fOnEvent),collie.util.addEventListener(a,"touchmove",this._fOnEvent),collie.util.addEventListener(a,"touchcancel",this._fOnEvent)):(collie.util.addEventListener(a,"mousedown",this._fOnEvent),collie.util.addEventListener(a,"mouseup",this._fOnEvent),collie.util.addEventListener(a,"mousemove",this._fOnEvent)),this._bAttached=!0},detachEvent:function(){var a=this._oLayer.getParent();this._bAttached&&(this._bHasTouchEvent?(collie.util.removeEventListener(a,"touchstart",this._fOnEvent),collie.util.removeEventListener(a,"touchend",this._fOnEvent),collie.util.removeEventListener(a,"touchmove",this._fOnEvent),collie.util.removeEventListener(a,"touchcancel",this._fOnEvent)):(collie.util.removeEventListener(a,"mousedown",this._fOnEvent),collie.util.removeEventListener(a,"mouseup",this._fOnEvent),collie.util.removeEventListener(a,"mousemove",this._fOnEvent)),this._bAttached=!1)},_onEvent:function(a){if(this._oLayer._htOption.useEvent){a=a||window.event;var b=this._bHasTouchEvent?a.changedTouches[0]:a||window.event,c=this._bHasTouchEvent?this._getEventTargetElement(a):a.target||a.srcElement,d=c.ownerDocument||document,e=d.body||d.documentElement,f=this._bHasTouchEvent?b.pageX:b.pageX||b.clientX+e.scrollLeft-d.body.clientLeft,g=this._bHasTouchEvent?b.pageY:b.pageY||b.clientY+e.scrollTop-d.body.clientTop,h=a.type,i=this._oLayer.getParentPosition(),j=f-i.x-this._oLayer._htOption.x,k=g-i.y-this._oLayer._htOption.y;j/=this._htEventRatio.width,k/=this._htEventRatio.height,"touchcancel"===h&&null!==this._htEventStartPos&&(j=this._htEventStartPos.x,k=this._htEventStartPos.y),h=this._convertEventType(h),("mousemove"===h||"mousedown"===h)&&collie.Renderer.isPreventDefault()&&collie.util.stopEventDefault(a),"mousedown"===h&&(this._htEventStartPos={x:j,y:k});var l=this._fireEvent(a,h,j,k);if("mouseup"===h){var m=this.THRESHOLD_CLICK,n=this.THRESHOLD_CLICK;this._htEventStartPos&&this._htEventStartPos.x-m<=j&&j<=this._htEventStartPos.x+m&&this._htEventStartPos.y-n<=k&&k<=this._htEventStartPos.y+n&&this._fireEvent(a,"click",j,k),this._htEventStartPos=null}collie.Renderer.setEventStatus(h,l)}},_fireEvent:function(a,b,c,d){var e=null,f=!0;if("mousemove"!==b&&!collie.Renderer.isStopEvent(b)){var g=this._oLayer.getChildren();e=this._getTargetOnHitEvent(g,c,d),e&&(f=this._bubbleEvent(e,b,a,c,d),"mousedown"===b&&this._setMousedownObject(e),"mouseup"===b&&this._unsetMousedownObject(e))}return"mouseup"===b&&null!==this._getMousedownObject()&&(e=this._getMousedownObject(),this._bubbleEvent(e,b,a,c,d),this._unsetMousedownObject(e)),f&&this._oLayer.fireEvent(b,{event:a,displayObject:e,x:c,y:d}),!!e},_getTargetOnHitEvent:function(a,b,c){var d=null;if(!(a instanceof Array))return this._isPointInDisplayObjectBoundary(a,b,c)?a:!1;for(var e=a.length-1;e>=0;e--){if(a[e].hasChild()&&(d=this._getTargetOnHitEvent(a[e].getChildren(),b,c)))return d;if(d=this._getTargetOnHitEvent(a[e],b,c))return d}},_convertEventType:function(a){var b=a;switch(a){case"touchstart":b="mousedown";break;case"touchmove":b="mousemove";break;case"touchend":case"touchcancel":b="mouseup";break;case"tap":b="click"}return b},_getEventTargetElement:function(a){for(var b=a.target;1!=b.nodeType;)b=b.parentNode;return b},_bubbleEvent:function(a,b,c,d,e,f){return a.fireEvent(b,{displayObject:f||a,event:c,x:d,y:e})===!1?!1:a.getParent()&&!this._bubbleEvent(a.getParent(),b,c,d,e,a)?!1:!0},_isPointInDisplayObjectBoundary:function(a,b,c){if(!a._htOption.useEvent||!a._htOption.visible||!a._htOption.width||!a._htOption.height||"auto"===a._htOption.useEvent&&!a.hasAttachedHandler())return!1;var d=a.getHitAreaBoundary();if(d.left<=b&&b<=d.right&&d.top<=c&&c<=d.bottom){if(a._htOption.hitArea){var e=a.getRelatedPosition();b-=e.x,c-=e.y;var f=a._htOption.hitArea;return f=collie.Transform.points(a,f),this._isPointInPolygon(f,b,c)}return!0}return!1},_isPointInPolygon:function(a,b,c){for(var d=!1,e=0,f=a.length-1,g=a.length;g>e;f=e++)a[e][1]>c!=a[f][1]>c&&b<(a[f][0]-a[e][0])*(c-a[e][1])/(a[f][1]-a[e][1])+a[e][0]&&(d=!d);return d},_setMousedownObject:function(a){this._oMousedownObject=a},_unsetMousedownObject:function(a){this._oMousedownObject===a&&(this._oMousedownObject=null)},_getMousedownObject:function(){return this._oMousedownObject},setEventRatio:function(a,b){this._htEventRatio.width=a||this._htEventRatio.width,this._htEventRatio.height=b||this._htEventRatio.height},getEventRatio:function(){return this._htEventRatio}}),collie.Layer=collie.Class({type:"layer",$init:function(a){this.option({x:0,y:0,width:320,height:480,useEvent:!0,visible:!0,freeze:!1,renderingMode:"inherit"}),this._sAlignLeft=null,this._sAlignTop=null,void 0!==a&&("x"in a&&("left"===a.x||"right"===a.x||"center"===a.x)&&(this._sAlignLeft=a.x,a.x=0),"y"in a&&("top"===a.y||"bottom"===a.y||"center"===a.y)&&(this._sAlignTop=a.y,a.y=0),this.option(a)),this._renderingMode="inherit"===this._htOption.renderingMode?collie.Renderer.getRenderingMode():this._htOption.renderingMode,"canvas"!==this._renderingMode||collie.util.getDeviceInfo().supportCanvas||(this._renderingMode="dom"),this.drawCount=0,this.optionSetter("visible",this._setVisible.bind(this)),this._elParent=null,this._bChanged=!1,this._aDisplayObjects=[],this._bLoaded=!1,this._oEvent=new collie.LayerEvent(this),this._makeDrawing(),this._setVisible()
},_makeDrawing:function(){this._oDrawing="dom"===this._renderingMode?new collie.LayerDOM(this):new collie.LayerCanvas(this)},getDrawing:function(){return this._oDrawing},getRenderingMode:function(){return this._renderingMode},getEvent:function(){return this._oEvent},getParent:function(){return this._elParent||!1},load:function(a,b){this.unload(),this._bLoaded=!0,this._elParent=this._elParent||a,this._elParent.style.width=Math.max(parseInt(this._elParent.style.width||0,10),this.option("width"))+"px",this._elParent.style.height=Math.max(parseInt(this._elParent.style.height||0,10),this.option("height"))+"px",this.getElement().style.zIndex=b,null!==this._sAlignLeft&&this.offset(this._sAlignLeft,null,!0),null!==this._sAlignTop&&this.offset(null,this._sAlignTop,!0),this._elParent.appendChild(this.getElement())},unload:function(){this.isLoaded()&&(this._oEvent.detachEvent(),this._elParent.removeChild(this.getElement()),this._elParent=null,this._bLoaded=!1)},attachEvent:function(){this._oEvent.attachEvent()},detachEvent:function(){this._oEvent.detachEvent()},_setVisible:function(){this.getElement()&&(this.getElement().style.display=this.option("visible")?"block":"none")},isLoaded:function(){return this._bLoaded},addChild:function(a){collie.util.pushWithSort(this._aDisplayObjects,a),a.setLayer(this),this.setChanged()},addChildren:function(a){for(var b=0,c=a.length;c>b;b++)this.addChild(a[b])},removeChild:function(a,b){if(a.unsetLayer(),"undefined"!=typeof b)this._aDisplayObjects.splice(b,1);else for(var c=0,d=this._aDisplayObjects.length;d>c;c++)if(this._aDisplayObjects[c]===a){this._aDisplayObjects.splice(c,1);break}this.setChanged()},removeChildren:function(a){for(var b=a.length-1;b>=0;b--)a[b]&&this.removeChild(a[b],b)},addTo:function(a){return a=a||collie.Renderer,a.addLayer(this),this},changeDisplayObjectZIndex:function(a){this.removeChild(a),this.addChild(a)},getChildren:function(){return this._aDisplayObjects},hasChild:function(){return this._aDisplayObjects&&this._aDisplayObjects.length>0},setChanged:function(){this._bChanged=!0},isChanged:function(){return this._bChanged},unsetChanged:function(){this._bChanged=!1},getContext:function(){return"getContext"in this._oDrawing?this._oDrawing.getContext():!1},getElement:function(){return"getElement"in this._oDrawing?this._oDrawing.getElement():!1},update:function(a){if(this.drawCount=0,this.isChanged()&&!this.option("freeze")){this.clear(),this.unsetChanged();for(var b=this.option("width"),c=this.option("height"),d=0,e=this._aDisplayObjects.length;e>d;d++)this._aDisplayObjects[d].update(a,0,0,b,c)}},clear:function(){this._oDrawing.clear()},resize:function(a,b,c){c||(this.option("width",a||this._htOption.width),this.option("height",b||this._htOption.height)),this._oDrawing&&this._oDrawing.resize(a,b,c),this._elParent&&(this._elParent.style.width=Math.max(parseInt(this._elParent.style.width||0,10),a||this.option("width"))+"px",this._elParent.style.height=Math.max(parseInt(this._elParent.style.height||0,10),b||this.option("height"))+"px"),this.fireEvent("resize")},offset:function(a,b,c){var d=this.getElement();if("undefined"!=typeof a&&null!==a){switch(a){case"left":a=0;break;case"right":a=parseInt(this._elParent.style.width,10)-this._htOption.width;break;case"center":a=parseInt(this._elParent.style.width,10)/2-this._htOption.width/2}this.option("x",a),d.style.left=a+"px",c||(this._sAlignLeft=null)}if("undefined"!=typeof b&&null!==b){switch(b){case"top":b=0;break;case"bottom":b=parseInt(this._elParent.style.height,10)-this._htOption.height;break;case"center":b=parseInt(this._elParent.style.height,10)/2-this._htOption.height/2}this.option("y",b),d.style.top=b+"px",c||(this._sAlignTop=null)}},setParent:function(a){"string"==typeof a&&(a=document.getElementById(a)),this._bLoaded?(this._oEvent.detachEvent(),this._elParent.removeChild(this.getElement()),this._elParent=a,this._elParent.appendChild(this.getElement()),this._oEvent.attachEvent()):this._elParent=a},getParentPosition:function(){return null!==this._elParent?this._elParent===collie.Renderer.getElement()?collie.Renderer.getPosition():collie.util.getPosition(this._elParent):void 0},clone:function(a){var b=new this.constructor(this._htOption);if(a&&this._aDisplayObjects.length)for(var c=0,d=this._aDisplayObjects.length;d>c;c++)this._aDisplayObjects[c].clone(!0).addTo(b);return b}},collie.Component),collie.DisplayObjectCanvas=collie.Class({$init:function(a){this._oDisplayObject=a,this._bUseCache=!1,this._oDebugHitArea=null,this._htEvent={},this._oLayer=null,this._htInfo=this._oDisplayObject.get(),this._bIsRetinaDisplay=null,this._htInfo.useCache&&this.loadCache()},loadCache:function(){this._bUseCache||(this._bUseCache=!0,this._elCache=document.createElement("canvas"),this._elCache.width=this._htInfo.width,this._elCache.height=this._htInfo.height,this._oContextCache=this._elCache.getContext("2d"))},unloadCache:function(){this._bUseCache&&(this._oContextCache=null,this._elCache=null,this._bUseCache=!1)},clearCache:function(){this._bUseCache&&(this._oContextCache.clearRect(0,0,this._elCache.width,this._elCache.height),this._elCache.width=this._htInfo.width*(this._bIsRetinaDisplay?2:1),this._elCache.height=this._htInfo.height*(this._bIsRetinaDisplay?2:1))},drawImage:function(a,b,c,d,e,f,g,h,j){var k=this._oDisplayObject.getImage(),l=this._oDisplayObject._nImageWidth,m=this._oDisplayObject._nImageHeight;if(collie.Renderer.isRetinaDisplay()){for(i=1,len=arguments.length;len>i;i++)arguments[i]*=2;l*=2,m*=2}try{a.drawImage(k,b,c,d,e,f,g,h,j)}catch(n){throw new Error("invalid drawImage value : "+b+","+c+","+d+","+e+","+f+","+g+","+h+","+j+","+this._oDisplayObject.getImage().src+", original : "+this._oDisplayObject.getImage().width+","+this._oDisplayObject.getImage().height+",source : "+k.width+","+k.height+", isCached : "+(null!==this._elImageCached?"true":"false"))}},load:function(){this._oLayer=this._oDisplayObject.getLayer(),this._oContext=this._oDisplayObject.getLayer().getContext(),this._bIsRetinaDisplay=collie.Renderer.isRetinaDisplay()},unload:function(){this._oLayer=null,this._oContext=null},draw:function(a,b,c,d,e,f){var g=f?!0:!1;f=f||this._oContext;var h=this._bUseCache?this._oContextCache:f,i=f,j=this._htInfo,k=(this._oDisplayObject.getDirty(),this._oDisplayObject.getOrigin()),l=j.width,m=j.height,n=k.x,o=k.y,p=b,q=c,r=this._bIsRetinaDisplay?2:1,s=0,t=!1,u=f;if(j.useCache&&(f=this._oContextCache),this._bIsRetinaDisplay&&(b*=2,c*=2,n*=2,o*=2,l*=2,m*=2),(this._bUseCache||1!==j.scaleX||1!==j.scaleY||0!==j.angle||1!==j.opacity)&&(t=!0,this._bUseCache&&(u=g?i:this._oContext),u.save(),u.translate(b+n,c+o),1!==j.opacity&&(s=u.globalAlpha,u.globalAlpha=0===u.globalAlpha?j.opacity:u.globalAlpha*j.opacity),0!==j.angle&&u.rotate(collie.util.toRad(j.angle)),(1!==j.scaleX||1!==j.scaleY)&&u.scale(j.scaleX,j.scaleY),u.translate(-n,-o),b=c=0),this._htEvent.displayObject=this,this._htEvent.context=h,this._htEvent.x=b,this._htEvent.y=c,!this._bUseCache||this._oDisplayObject.isChanged()&&!this._oDisplayObject.isChanged(!0)){if(this.clearCache(),j.backgroundColor&&(h.fillStyle=j.backgroundColor,h.fillRect(b,c,l,m)),this._oDisplayObject.getImage()){var v=(this._oDisplayObject.getImage(),this._oDisplayObject.getImageSize());if(j.backgroundRepeat&&"no-repeat"!==j.backgroundRepeat){var w="repeat"===j.backgroundRepeat||"repeat-x"===j.backgroundRepeat?Math.ceil(j.width/v.width):1,x="repeat"===j.backgroundRepeat||"repeat-y"===j.backgroundRepeat?Math.ceil(j.height/v.height):1;if(w>0||x>0)for(var y=0;w>y;y++)for(var z=0;x>z;z++){var A=y*v.width+v.width,B=z*v.height+v.height,C=A>j.width?v.width-(A-j.width):v.width,D=B>j.height?v.height-(B-j.height):v.height;this.drawImage(h,0,0,C,D,b/r+y*v.width,c/r+z*v.height,C,D)}}else{var E=Math.min(v.width,j.width),F=Math.min(v.height,j.height);this.drawImage(h,j.offsetX,j.offsetY,j.fitImage?v.width:E,j.fitImage?v.height:F,b/r,c/r,j.fitImage?j.width:E,j.fitImage?j.height:F)}}"onCanvasDraw"in this._oDisplayObject&&this._oDisplayObject.onCanvasDraw(this._htEvent)}if(j.debugHitArea&&j.hitArea&&null===this._oDebugHitArea&&(this._oDebugHitArea=new collie.Polyline({x:0,y:0,width:j.width,height:j.height,strokeColor:j.debugHitArea===!0?"yellow":j.debugHitArea,strokeWidth:3}).addTo(this._oDisplayObject),this._oDebugHitArea.setPointData(j.hitArea)),this._oDisplayObject.hasChild()&&(!j.useCache||this._oDisplayObject.isChanged()&&!this._oDisplayObject.isChanged(!0)))for(var G=this._oDisplayObject.getChildren(),H=0,I=G.length;I>H;H++)G[H].update(a,j.useCache||t?0:p,j.useCache||t?0:q,d,e,g||j.useCache?f:null),G[H].unsetChanged(),G[H]._resetDirty();j.useCache&&(g?i:this._oContext).drawImage(f.canvas,0,0),this._oLayer.drawCount++,t&&u.restore()}}),collie.DisplayObjectDOM=collie.Class({$init:function(a){this._oDisplayObject=a,this._htInfo=this._oDisplayObject.get(),this._oLayer=null,this._elImage=null,this._aTransformValue=[],this._sTransformValue=null,this._sTransform=collie.util.getCSSPrefix("transform",!0),this._sOrigin=collie.util.getCSSPrefix("transform-origin",!0),this._bSupportCSS3=collie.util.getSupportCSS3(),this._bSupportCSS3d=collie.util.getSupportCSS3d(),this._bUseTransform=this._bSupportCSS3||this._bSupportCSS3d,this._htDeviceInfo=collie.util.getDeviceInfo(),this._bIsAndroid=!!this._htDeviceInfo.android,this._nAndroidVersion=this._htDeviceInfo.android,this._bIsIEUnder8=this._htDeviceInfo.ie&&this._htDeviceInfo.ie<9,this._bUseTranslateZ=!0,this._bIsRetinaDisplay=null,this._htEvent={},this._oEmptyObject={},this._sCacheTransformValue=null,this._initElement()},_initElement:function(){this._elContainer=document.createElement("div"),this._elContainer.id=collie.DisplayObjectDOM.ID+this._oDisplayObject.getId()+(this._htInfo.name?"_"+this._htInfo.name:""),this._elContainer.className=collie.DisplayObjectDOM.CLASSNAME,this._elContainerStyle=this._elContainer.style,this._elContainerStyle.position="absolute",this._bIsIEUnder8&&(this._elContainerStyle.width=this._htInfo.width+"px",this._elContainerStyle.height=this._htInfo.height+"px"),this._el=document.createElement("div"),this._elStyle=this._el.style,this._bSupportCSS3d&&(this._elStyle[this._sTransform]="translateZ(0)"),this._elStyle.position="absolute",this._elStyle.width=this._htInfo.width+"px",this._elStyle.height=this._htInfo.height+"px",this._elStyle.overflow="hidden",this._elContainer.appendChild(this._el)},load:function(){this._oLayer=this._oDisplayObject.getLayer(),this._oDisplayObject.getParent()?this._oDisplayObject.getParent().getDrawing().getElement().appendChild(this._elContainer):this._oLayer.getElement().appendChild(this._elContainer),this._bIsRetinaDisplay=collie.Renderer.isRetinaDisplay()},unload:function(){this._oLayer=null,this._elContainer.parentNode.removeChild(this._elContainer)},getElement:function(){return this._elContainer},getItemElement:function(){return this._el},draw:function(a,b,c){this._htEvent.displayObject=this,this._htEvent.element=this._el,this._htEvent.x=b,this._htEvent.y=c;{var d=this._htInfo,e=this._oDisplayObject.getDirty()||this._oEmptyObject,f=this._oDisplayObject.getOrigin();this._bIsRetinaDisplay?2:1}e.visible&&(this._elContainerStyle.display=d.visible?"block":"none"),e.width&&(this._elStyle.width=d.width+"px",this._bIsIEUnder8&&(this._elContainerStyle.width=d.width+"px")),e.height&&(this._elStyle.height=d.height+"px"),e.opacity&&(this._bIsIEUnder8?this._elContainerStyle.filter="alpha(opacity="+100*d.opacity+")":(this._elContainerStyle.opacity=d.opacity,this._elImage&&this._nAndroidVersion&&this._nAndroidVersion>=4.1&&(this._elImage.style.opacity=d.opacity))),e.zIndex&&(this._elContainerStyle.zIndex=d.zIndex),e.backgroundColor&&(this._elStyle.backgroundColor=d.backgroundColor),this._bUseTransform?this._aTransformValue.push(this._makeTranslate(d.x,d.y,d.zIndex)):(e.x||e.y)&&(this._elContainerStyle.left=d.x+"px",this._elContainerStyle.top=d.y+"px"),this._bUseTransform&&((e.originX||e.originY||e.width||e.height)&&(this._elContainerStyle[this._sOrigin]=f.x+"px "+f.y+"px"),0!==d.angle&&this._aTransformValue.push("rotate",this._bSupportCSS3d&&!this._bIsAndroid?"Z":"","(",d.angle,"deg) "),(1!==d.scaleX||1!==d.scaleY)&&this._aTransformValue.push("scale(",d.scaleX,", ",d.scaleY,") ")),this._bUseTransform&&this._applyTransform(),this._drawImage(d,e),"onDOMDraw"in this._oDisplayObject&&this._oDisplayObject.onDOMDraw(this._htEvent),this._oLayer.drawCount++},_drawImage:function(a,b){var c=this._oDisplayObject.getImage(),d=a.backgroundRepeat&&"no-repeat"!==a.backgroundRepeat,e=0,f=0;if(this._oDisplayObject._htOption.fitImage)e=this._oDisplayObject._htOption.width,f=this._oDisplayObject._htOption.height;else{var g=this._oDisplayObject.getImageSize();e=g.width,f=g.height}if((b.backgroundImage||b.backgroundRepeat)&&(null!==this._elImage&&(!a.backgroundImage||a.backgroundRepeat&&"no-repeat"!==a.backgroundRepeat)&&(this._el.removeChild(this._elImage),this._elImage=null),a.backgroundImage&&c))if(!d&&a.backgroundImage){var h;null===this._elImage?(this._elImage=c.cloneNode(),h=this._elImage.style,h.position="absolute",h.top=0,h.left=0,h.width=e+"px",h.height=f+"px",h.visibility="visible",this._nAndroidVersion&&this._nAndroidVersion>=4.1&&(h.opacity=a.opacity),this._bSupportCSS3d&&this._bUseTranslateZ&&(h[this._sTransform]="translateZ(0)"),this._el.hasChildNodes()?this._el.insertBefore(this._elImage,this._el.childNodes[0]):this._el.appendChild(this._elImage)):(this._elImage.src=c.src,h=this._elImage.style,h.width=e+"px",h.height=f+"px",h.visibility="visible")}else d&&(this._elStyle.backgroundImage='url("'+c.src+'")',this._elStyle.backgroundRepeat=a.backgroundRepeat);a.backgroundImage&&null!==this._elImage&&(this._bIsRetinaDisplay&&d&&(b.width||htDirth.height||b.backgroundRepeat||b.backgroundImage)&&(this._elStyle.backgroundSize=a.width+"px "+a.height+"px"),(b.offsetX||b.offsetY)&&(this._bUseTransform?this._elImage.style[this._sTransform]=this._makeTranslate(-a.offsetX,-a.offsetY,1):(this._elImage.style.left=-a.offsetX+"px",this._elImage.style.top=-a.offsetY+"px")))},_makeTranslate:function(a,b,c){var d="",e=0!==this._htInfo.angle&&this._bIsAndroid?!1:this._bSupportCSS3d;return e?d="translate3d("+a+"px, "+b+"px, "+c+"px) ":this._bSupportCSS3&&(d="translate("+a+"px, "+b+"px) "),d},_applyTransform:function(){var a=this._aTransformValue.join("");this._sCacheTransformValue!==a&&(this._elContainerStyle[this._sTransform]=a,this._sCacheTransformValue=a,this._bIsAndroid&&this._bUseTranslateZ&&0!==this._htInfo.angle?(this._elStyle[this._sTransform]="",this._elImage&&this._oDisplayObject.setChanged(),this._bUseTranslateZ=!1):this._bUseTranslateZ||0!==this._htInfo.angle&&this._bIsAndroid||!this._bSupportCSS3d||(this._elStyle[this._sTransform]="translateZ(0)",this._elImage&&this._oDisplayObject.setChanged(),this._bUseTranslateZ=!0)),this._aTransformValue=[]}},collie.Component),collie.DisplayObjectDOM.CLASSNAME="_collie_displayObject",collie.DisplayObjectDOM.ID="_collie_displayObject_",collie.DisplayObject=collie.Class({type:"displayobject",$init:function(a){this._bInitOption=!0,this._htOption={name:"",width:"auto",height:"auto",x:0,y:0,zIndex:0,opacity:1,angle:0,scaleX:1,scaleY:1,originX:"center",originY:"center",offsetX:0,offsetY:0,spriteX:null,spriteY:null,spriteLength:0,spriteSheet:null,rangeX:null,rangeY:null,positionRepeat:!1,backgroundColor:"",backgroundImage:"",backgroundRepeat:"no-repeat",hitArea:null,debugHitArea:!1,useCache:!1,useEvent:"auto",fitImage:!1,velocityX:0,velocityY:0,velocityRotate:0,forceX:0,forceY:0,forceRotate:0,mass:1,friction:0,useRealTime:!0,visible:!0},a&&this.option(a),this._htDirty={},this._htMatrix={},this._sId=++collie.DisplayObject._idx,this._elImage=null,this._aDisplayObjects=[],this._oLayer=null,this._oParent=null,this._oDrawing=null,this._bIsSetOption=!1,this._bChanged=!0,this._bChangedTransforms=!0,this._bCustomSize=!1,this._aChangedQueue=null,this._htGetImageData=null,this._htRelatedPosition={},this._htParentRelatedPosition={},this._htBoundary={},this._sRenderingMode=null,this._bRetinaDisplay=collie.Renderer.isRetinaDisplay(),this._oTimerMove=null,this._nPositionRight=null,this._nPositionBottom=null,this._nImageWidth=0,this._nImageHeight=0,this._htImageSize=null,this._htSpriteSheet=null,this._htOrigin={x:0,y:0},this.set(this._htOption),this._bIsSetOption=!0},set:function(a,b,c,d){if("object"==typeof a)for(var e in a)this.set(e,a[e]);else{if(this._bIsSetOption&&this._htOption[a]===b)return;("width"===a||"height"===a)&&("auto"!==b?this._bCustomSize=!0:b="auto"===b&&null!==this.getImage()?this.getImageSize()[a]:100),this._htOption[a]=b,this.setDirty(a),c||this._setter(a,b),d||this.setChanged("x"===a||"y"===a||"angle"===a||"scaleX"===a||"scaleY"===a||"opacity"===a?!0:!1)}return this},_setter:function(a,b){"zIndex"===a&&(this._oParent?this._oParent.changeDisplayObjectZIndex(this):this.getLayer()&&this._oLayer.changeDisplayObjectZIndex(this)),("x"===a||"y"===a)&&("string"==typeof b&&this.align("x"===a?b:!1,"y"===a?b:!1),this._fixPosition(),this.resetPositionCache()),"backgroundImage"===a&&this.setImage(b),("spriteX"===a||"spriteY"===a||"spriteSheet"===a)&&this._setSpritePosition(a,b),("width"===a||"height"===a)&&(null!==this._htOption.spriteX&&this._setSpritePosition("spriteX",this._htOption.spriteX),null!==this._htOption.spriteY&&this._setSpritePosition("spriteY",this._htOption.spriteY)),"hitArea"===a&&b instanceof Array&&this._makeHitAreaBoundary(),("width"===a||"height"===a||"originX"===a||"originY"===a)&&this._setOrigin(),"backgroundRepeat"===a&&"no-repeat"!==b&&this.set("useCache",!0),"useCache"===a&&null!==this._oDrawing&&this._oDrawing.loadCache&&(b?this._oDrawing.loadCache():this._oDrawing.unloadCache())},get:function(a){return a?this._htOption[a]:this._htOption},setDirty:function(a){if(null===this._htDirty&&(this._htDirty={}),"undefined"==typeof a)for(var b in this._htOption)this._htDirty[b]=!0;else this._htDirty[a]=!0},getDirty:function(a){return a?this._htDirty[a]?!0:!1:this._htDirty},_resetDirty:function(){this._htDirty=null},addChild:function(a){collie.util.pushWithSort(this._aDisplayObjects,a),a.setParent(this),null!==this._oLayer&&a.setLayer(this._oLayer),this.setChanged()},removeChild:function(a,b){if("undefined"!=typeof b)this._aDisplayObjects[b].unsetLayer(),this._aDisplayObjects[b].unsetParent(),this._aDisplayObjects.splice(b,1);else for(var c=0,d=this._aDisplayObjects.length;d>c;c++)if(this._aDisplayObjects[c]===a){this._aDisplayObjects[c].unsetLayer(),this._aDisplayObjects[c].unsetParent(),this._aDisplayObjects.splice(c,1);break}this.setChanged()},changeDisplayObjectZIndex:function(a){this.removeChild(a),this.addChild(a)},addTo:function(a){if(this._oLayer||this._oParent){if(this._oLayer===a||this._oParent===a)return this;this.leave()}return a.addChild(this),this},hasChild:function(){return this._aDisplayObjects.length>0},getChildren:function(){return this._aDisplayObjects},getParent:function(){return this._oParent||!1},setParent:function(a){this._oParent=a},unsetParent:function(){this._oParent=null},leave:function(){var a=null;return null!==this._oParent?a=this._oParent:this._oLayer&&(a=this.getLayer()),a&&a.removeChild(this),this},getId:function(){return this._sId},getImage:function(){return this._elImage||null},getImageSize:function(){return this._htImageSize||!1},setImage:function(a){return"string"!=typeof a&&a?(this._elImage&&this._elImage===a||(this._elImage=a,this._nImageWidth=a.width,this._nImageHeight=a.height,this._htImageSize={width:this._bRetinaDisplay?this._nImageWidth/2:this._nImageWidth,height:this._bRetinaDisplay?this._nImageHeight/2:this._nImageHeight},this._htSpriteSheet=collie.ImageManager.getSprite(this._htOption.backgroundImage),this._bCustomSize||this.set({width:this._htImageSize.width,height:this._htImageSize.height}),this._setSpritePosition("spriteSheet",this._htOption.spriteSheet),this._setSpritePosition("spriteX",this._htOption.spriteX),this._setSpritePosition("spriteY",this._htOption.spriteY),this.setDirty("backgroundImage"),this.setChanged()),void 0):(null!==this._htGetImageData&&this._htGetImageData.name!==a&&(collie.ImageManager.cancelGetImage(this._htGetImageData.name,this._htGetImageData.callback),this._htGetImageData=null),a?(this._htGetImageData={name:a,callback:function(a){this.setImage(a)}.bind(this)},collie.ImageManager.getImage(this._htGetImageData.name,this._htGetImageData.callback)):(this._elImage=null,this.setChanged()),void 0)},getDrawing:function(){return this._oDrawing},setChanged:function(a){this._bChanged||a&&this._bChangedTransforms||(null!==this._oLayer&&this._oLayer.setChanged(),a||(this._bChanged=!0),this._bChangedTransforms=!0,this._oParent&&this._oParent.setChanged(!1))},unsetChanged:function(){this._bChanged=!1,this._bChangedTransforms=!1},isChanged:function(a){return a?!this._bChanged&&this._bChangedTransforms:this._bChanged||this._bChangedTransforms},setLayer:function(a){if(this._sId in collie.DisplayObject.htFactory)throw new Error("Exists DisplayObject Id "+this._sId);collie.DisplayObject.htFactory[this._sId]=this,this._oLayer=a,this._sRenderingMode=this._oLayer.getRenderingMode(),this._makeDrawing(),this._oDrawing.load(),this.setChanged(),("string"==typeof this._htOption.x||"string"==typeof this._htOption.y)&&this.align("string"==typeof this._htOption.x?this._htOption.x:!1,"string"==typeof this._htOption.y?this._htOption.y:!1),null!==this._nPositionRight&&(this.right(this._nPositionRight),this._nPositionRight=null),null!==this._nPositionBottom&&(this.bottom(this._nPositionBottom),this._nPositionBottom=null);for(var b=0,c=this._aDisplayObjects.length;c>b;b++)this._aDisplayObjects[b].setLayer(a)},unsetLayer:function(){if(this.getLayer()){for(var a=0,b=this._aDisplayObjects.length;b>a;a++)this._aDisplayObjects[a].unsetLayer();this._oDrawing.unload(),this.setDirty(),this.setChanged(),this._sRenderingMode=null,this._oDrawing=null,this._oLayer=null,delete collie.DisplayObject.htFactory[this._sId]}},_makeDrawing:function(){null===this._oDrawing&&(this._oDrawing="dom"===this._sRenderingMode?new collie.DisplayObjectDOM(this):new collie.DisplayObjectCanvas(this))},getLayer:function(){return this._oLayer||!1},addMatrix:function(a){if(a instanceof Array)for(var b=0,c=a.length;c>b;b++)this.addMatrix(a[b]);else this._htMatrix[a.name]=a,delete this._htMatrix[a.name].name},changeMatrix:function(a){a in this._htMatrix&&this.set(this._htMatrix[a])},update:function(a,b,c,d,e,f){if(this._updateMovableOption(a),"canvas"===this._sRenderingMode&&!this._htOption.visible)return this.unsetChanged(),void 0;if(b+=this._htOption.x,c+=this._htOption.y,("dom"===this._sRenderingMode&&this.isChanged()||"canvas"===this._sRenderingMode&&(b+this._htOption.width>=0||d>=b||c+this._htOption.height>=0||e>=c))&&this._oDrawing.draw(a,b,c,d,e,f),this.unsetChanged(),this._resetDirty(),(0!==this._htOption.velocityX||0!==this._htOption.velocityY||0!==this._htOption.velocityRotate||0!==this._htOption.forceX||0!==this._htOption.forceY||0!==this._htOption.forceRotate)&&this.setChanged(!0),"canvas"!==this._sRenderingMode&&this._htOption.visible&&this.hasChild())for(var g=0,h=this._aDisplayObjects.length;h>g;g++)this._aDisplayObjects[g].update(a,b,c,d,e)},_updateMovableOption:function(a){if(0!==this._htOption.velocityX||0!==this._htOption.velocityY||0!==this._htOption.velocityRotate||0!==this._htOption.forceX||0!==this._htOption.forceY||0!==this._htOption.forceRotate){var b=Math.max(17,a)/1e3;this._htOption.useRealTime||(b=1);var c=this._htOption.velocityX,d=this._htOption.velocityY,e=this._htOption.x,f=this._htOption.y;c+=this._htOption.forceX/this._htOption.mass*b,d+=this._htOption.forceY/this._htOption.mass*b;var g=this._htOption.friction*c*this._htOption.mass*b,h=this._htOption.friction*d*this._htOption.mass*b;if(0!==c&&(c=Math.abs(c)/c!==Math.abs(c-g)/(c-g)?0:c-g),0!==d&&(d=Math.abs(d)/d!==Math.abs(d-h)/(d-h)?0:d-h),e+=c*b,f+=d*b,c=Math.floor(1e3*c)/1e3,d=Math.floor(1e3*d)/1e3,this._htOption.friction&&Math.abs(c)<.05&&(c=0),this._htOption.friction&&Math.abs(d)<.05&&(d=0),(e!==this._htOption.x||f!==this._htOption.y||c!==this._htOption.velocityX||d!==this._htOption.velocityY)&&(this.set("x",e),this.set("y",f),this.set("velocityX",c),this.set("velocityY",d)),0!==this._htOption.forceRotate&&this.set("velocityRotate",this._htOption.velocityRotate+this._htOption.forceRotate),0!==this._htOption.velocityRotate){var i=collie.util.fixAngle(collie.util.toRad(this._htOption.angle+this._htOption.velocityRotate*b));this.set("angle",Math.round(1e3*collie.util.toDeg(i))/1e3)}}},getRelatedPosition:function(){if(null===this._htRelatedPosition.x&&(this._htRelatedPosition.x=this._htOption.x,this._htRelatedPosition.y=this._htOption.y,this._oParent)){var a=this._oParent.getRelatedPosition();this._htRelatedPosition.x+=a.x,this._htRelatedPosition.y+=a.y}return this._htRelatedPosition},getBoundary:function(a,b){var c=collie.Transform.getBoundary(this,b);if(this._htBoundary.left=c.left,this._htBoundary.right=c.right,this._htBoundary.top=c.top,this._htBoundary.bottom=c.bottom,this._htBoundary.isTransform=c.isTransform,this._htBoundary.points=c.points,a){var d=this.getRelatedPosition();if(this._htBoundary.points)for(var e=0,f=this._htBoundary.points.length;f>e;e++)this._htBoundary.points[e][0]+=d.x,this._htBoundary.points[e][1]+=d.y;this._htBoundary.left+=d.x,this._htBoundary.right+=d.x,this._htBoundary.top+=d.y,this._htBoundary.bottom+=d.y}return this._htBoundary},resetPositionCache:function(){if(this._htRelatedPosition.x=null,this._htRelatedPosition.y=null,this.hasChild())for(var a=0,b=this._aDisplayObjects.length;b>a;a++)this._aDisplayObjects[a].resetPositionCache()},getHitAreaBoundary:function(){if(this._htOption.hitArea){if(this._htOption.hitArea instanceof Array){var a=collie.Transform.points(this,collie.util.getBoundaryToPoints(this._htHitAreaBoundary)),b=collie.util.getBoundary(a),c=this.getRelatedPosition();return{left:b.left+c.x,right:b.right+c.x,top:b.top+c.y,bottom:b.bottom+c.y}}return this._htOption.hitArea.getBoundary(!0)}return this.getBoundary(!0)},getOrigin:function(){return this._htOrigin},_setOrigin:function(){switch(this._htOption.originX){case"left":this._htOrigin.x=0;break;case"right":this._htOrigin.x=this._htOption.width;break;case"center":this._htOrigin.x=this._htOption.width/2;break;default:this._htOrigin.x=parseInt(this._htOption.originX,10)}switch(this._htOption.originY){case"top":this._htOrigin.y=0;break;case"bottom":this._htOrigin.y=this._htOption.height;break;case"center":this._htOrigin.y=this._htOption.height/2;break;default:this._htOrigin.y=parseInt(this._htOption.originY,10)}},_fixPosition:function(){var a,b,c,d,e=this._htOption.x,f=this._htOption.y;if(this._htOption.rangeX){if(a=this._htOption.rangeX[0],b=this._htOption.rangeX[1],this._htOption.positionRepeat){if(a>e){do e+=b-a;while(a>e)}else if(e>b)do e-=b-a;while(e>b)}else e=Math.max(a,e),e=Math.min(b,e);e!==this._htOption.x&&this.set("x",e,!0)}if(this._htOption.rangeY){if(c=this._htOption.rangeY[0],d=this._htOption.rangeY[1],this._htOption.positionRepeat){if(c>f){do f+=d-c;while(c>f)}else if(f>d)do f-=d-c;while(f>d)}else f=Math.max(c,f),f=Math.min(d,f);f!==this._htOption.y&&this.set("y",f,!0)}},_makeHitAreaBoundary:function(){this._htHitAreaBoundary=collie.util.getBoundary(this._htOption.hitArea)},align:function(a,b,c){if(this.getLayer()){c=c||this.getParent();var d=0,e=0,f=0,g=0;c?(d=c._htOption.width,e=c._htOption.height):(d=this._oLayer._htOption.width,e=this._oLayer._htOption.height),a!==!1&&(f="right"===a?d-this._htOption.width:d/2-this._htOption.width/2,this.set("x",f)),b!==!1&&(g="bottom"===b?e-this._htOption.height:e/2-this._htOption.height/2,this.set("y",g))}},right:function(a){var b=0;return this._oParent&&(b=this._oParent._htOption.width),!b&&this._oLayer&&(b=this._oLayer._htOption.width),b?this.set("x",b-(this._htOption.width+a)):this._nPositionRight=a,this},bottom:function(a){var b=0;return this._oParent&&(b=this._oParent.get("height")),!b&&this._oLayer&&(b=this._oLayer.option("height")),b?this.set("y",b-(this._htOption.height+a)):this._nPositionBottom=a,this},resizeFixedRatio:function(a,b){if(this.getImage()){var c=this.getImage().width,d=this.getImage().height;a?b=a*(d/c):b&&(a=b*(c/d)),this.set("width",Math.round(a)),this.set("height",Math.round(b))}},_setSpritePosition:function(a,b){if(this._elImage&&null!==b)if(null!==this._htOption.spriteSheet){var c,d,e=this._htSpriteSheet[this._htOption.spriteSheet];"spriteSheet"===a&&this._htSpriteSheet&&this._htSpriteSheet[b]?("undefined"!=typeof e[0][0]?null!==this._htOption.spriteX?(c=e[this._htOption.spriteX][0],d=e[this._htOption.spriteX][1]):(c=e[0][0],d=e[0][1]):(c=e[0],d=e[1]),this.set("offsetX",c,!0),this.set("offsetY",d,!0)):"spriteX"===a&&"undefined"!=typeof e[b]&&(this.set("offsetX",e[b][0],!0),this.set("offsetY",e[b][1],!0))}else{var f=this.getImageSize(),g=this._htOption.width,h=this._htOption.height,i=this._htOption.spriteLength-1,j=f.width/this._htOption.width-1,k=f.height/this._htOption.height-1,l=f.width-1,m=f.height-1;switch(i>=0&&h<f.height&&(l=j*f.width,m=k*f.height),a){case"spriteX":var c=0,d=0;i>j&&h<f.height?(d=Math.floor(b/(j+1))*h,c=b%(j+1)*g):c=Math.min(b,j)*g,this.set("offsetX",c,!0),this.set("offsetY",d,!0);break;case"spriteY":b=Math.min(b,k),this.set("offsetY",b*h,!0)}}},hasAttachedHandler:function(){return this._htHandler&&"click"in this._htHandler&&this._htHandler.click.length>0||"mousedown"in this._htHandler&&this._htHandler.mousedown.length>0||"mouseup"in this._htHandler&&this._htHandler.mouseup.length>0?!0:!1},move:function(a,b,c,d){var e=this._htOption.x,f=this._htOption.y,g=collie.util.getDistance(e,f,a,b),h=Math.round(g/c*1e3);if(null!==this._oTimerMove&&(this._oTimerMove.stop(),this._oTimerMove=null),c&&!(h<collie.Renderer.getInfo().fps)){var i={from:[e,f],to:[a,b],set:["x","y"]};return d&&(i.onComplete=function(){d(this)}),this._oTimerMove=collie.Timer.transition(this,h,i),this._oTimerMove}this.set({x:a,y:b}),d&&d(this)},moveBy:function(a,b,c,d){var e=this._htOption.x,f=this._htOption.y;return this.move(e+a,f+b,c,d)},toString:function(){return"DisplayObject"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")},clone:function(a){var b=new this.constructor(this._htOption);if(a&&this._aDisplayObjects.length)for(var c=0,d=this._aDisplayObjects.length;d>c;c++)this._aDisplayObjects[c].clone(!0).addTo(b);return b}},collie.Component),collie.DisplayObject._idx=0,collie.DisplayObject.htFactory={},collie.MovableObject=collie.Class({$init:function(){}},collie.DisplayObject),collie.Rectangle=collie.Class({$init:function(){this.option({radius:0,strokeColor:"",strokeWidth:0,fillColor:"",fillImage:""},null,!0),this._sBorderRadius=collie.util.getCSSPrefix("border-radius",!0)},onDOMDraw:function(a){this._bChanged&&(this._htOption.radius&&(a.element.style[this._sBorderRadius]=this._htOption.radius+"px",a.element.style.borderRadius=this._htOption.radius+"px"),this._htOption.fillImage?collie.ImageManager.getImage(this._htOption.fillImage,function(b){a.element.style.backgroundImage="url('"+b.src+"')"}):this._htOption.fillColor&&(a.element.style.backgroundColor=this._htOption.fillColor),this._htOption.strokeWidth&&(a.element.style.border=this._htOption.strokeWidth+"px solid "+this._htOption.strokeColor),this._bChanged=!1)},onCanvasDraw:function(a){var b=a.context,c=this._htOption.radius,d=collie.Renderer.isRetinaDisplay(),e=this._htOption.width,f=this._htOption.height,g=this._htOption.strokeWidth;if(d&&(e*=2,f*=2,c*=2,g*=2),htInfo.fillImage){var h=collie.ImageManager.getImage(htInfo.fillImage);if(h){var i=b.createPattern(h,"repeat");b.fillStyle=i}else collie.ImageManager.getImage(htInfo.fillImage,function(){this.setChanged()}.bind(this))}else htInfo.fillColor&&(b.fillStyle=htInfo.fillColor);this._htOption.strokeColor&&(b.strokeStyle=this._htOption.strokeColor),this._htOption.strokeWidth&&(b.lineWidth=g),c?(b.save(),b.translate(a.x,a.y),b.beginPath(),b.moveTo(c,0),b.lineTo(e-c,0),b.quadraticCurveTo(e,0,e,c),b.lineTo(e,f-c),b.quadraticCurveTo(e,f,e-c,f),b.lineTo(c,f),b.quadraticCurveTo(0,f,0,f-c),b.lineTo(0,c),b.quadraticCurveTo(0,0,c,0),b.closePath(),b.restore(),(this._htOption.fillColor||this._htOption.fillImage)&&b.fill(),this._htOption.strokeWidth&&b.stroke()):((this._htOption.fillColor||this._htOption.fillImage)&&b.fillRect(a.x,a.y,e,f),this._htOption.strokeWidth&&b.strokeRect(a.x,a.y,e,f)),this._bChanged=!1
},toString:function(){return"Rectangle"+(this.get("name")?" "+this.get("name"):"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Circle=collie.Class({$init:function(){this.option({radius:0,strokeColor:"#000000",strokeWidth:0,fillColor:"",fillImage:"",startAngle:0,endAngle:360,closePath:!1,anticlockwise:!1,autoExpand:!0},null,!0),this._oPaper=null,this.optionSetter("radius",this._expandSize.bind(this)),this._expandSize()},_expandSize:function(){if(this._htOption.autoExpand&&this._htOption.radius){var a=2*this._htOption.radius+this._htOption.strokeWidth;this.set("width",a),this.set("height",a)}},onDOMDraw:function(a){var b=a.element;if("undefined"!=typeof Raphael){var c,d=this.get(),e=d.strokeWidth,f=d.radius,g=d.width,h=d.height,i=this.getDirty();if(null===this._oPaper?(this._oPaper=Raphael(b,g+e,h+e),this._oPaper.canvas.style.zIndex=10):i&&(i.width||i.height)&&this._oPaper.setSize(g,h),b.style.left=-(e/2)+"px",b.style.top=-(e/2)+"px",this._oPaper.clear(),f){var j=f,k=f,l=j+f*Math.cos(collie.util.toRad(d.startAngle)),m=k+f*Math.sin(collie.util.toRad(d.startAngle)),n=j+f*Math.cos(collie.util.toRad(d.endAngle)),o=k+f*Math.sin(collie.util.toRad(d.endAngle)),p=d.anticlockwise?d.startAngle-d.endAngle:d.endAngle-d.startAngle;Math.abs(p)>=360?p=360:0>p&&(p+=360);var q=p>180?1:0,r=d.anticlockwise?0:1;c=p>=360?this._oPaper.circle(j,k,f):this._oPaper.path("M"+l+","+m+"a"+f+","+f+",0,"+q+","+r+","+(n-l)+","+(o-m)+(d.closePath?"L"+j+","+k+"L"+l+","+m+"Z":""))}c&&(c.transform("t"+e/2+","+e/2),d.fillImage?collie.ImageManager.getImage(d.fillImage,function(a){c.attr("fill","url('"+a.src+"')")}):d.fillColor&&c.attr("fill",d.fillColor),d.strokeColor&&c.attr("stroke",d.strokeColor),c.attr("stroke-width",d.strokeWidth))}},onCanvasDraw:function(a){var b=this.get(),c=a.context,d=a.x,e=a.y,f=collie.Renderer.isRetinaDisplay(),g=b.radius,h=b.strokeWidth,i=b.width,j=b.height;if(f&&(i*=2,j*=2,g*=2,h*=2),b.fillImage){var k=collie.ImageManager.getImage(b.fillImage);if(k){var l=c.createPattern(k,"repeat");c.fillStyle=l}else collie.ImageManager.getImage(b.fillImage,function(){this.setChanged()}.bind(this))}else b.fillColor&&(c.fillStyle=b.fillColor);if(b.strokeColor&&(c.strokeStyle=b.strokeColor),h&&(c.lineWidth=h),g){var m=d+g,n=e+g,o=Math.abs(b.startAngle-b.endAngle)>=360;c.beginPath(),b.closePath&&!o&&c.moveTo(m,n),c.arc(m,n,g,collie.util.toRad(b.startAngle),collie.util.toRad(b.endAngle),b.anticlockwise),b.closePath&&c.closePath(),(b.fillColor||b.fillImage)&&c.fill(),b.strokeWidth&&c.stroke()}},center:function(a,b){return this.set("x",a-this._htOption.radius),this.set("y",b-this._htOption.radius),this},toString:function(){return"Circle"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Polyline=collie.Class({$init:function(){this.option({strokeColor:"#000000",strokeWidth:1,fillColor:"",fillImage:"",lineCap:"butt",lineJoin:"miter",miterLimit:10,dashArray:"",closePath:!1},null,!0),this._aPointData=[],this._oPaper=null,this._htPointBoundary={right:null,bottom:null}},setPointData:function(a,b){this._aPointData=a,this.setChanged(),b||this._expandBoundary(a)},getPointData:function(){return this._aPointData},addPoint:function(a,b,c){this._aPointData.push([a,b]),this.setChanged(),c||this._expandBoundary(a,b)},moveTo:function(a,b){this._aPointData.push([a,b,!0])},lineTo:function(a,b,c){this.addPoint(a,b,c)},resetPointData:function(){this._aPointData=[],this._htPointBoundary={right:null,bottom:null},this.setChanged()},_expandBoundary:function(a,b,c){if(a instanceof Array)for(var d=0,e=a.length;e>d;d++)this._expandBoundary(a[d][0],a[d][1],!0);else this._htPointBoundary.right=null===this._htPointBoundary.right?a:Math.max(a,this._htPointBoundary.right),this._htPointBoundary.bottom=null===this._htPointBoundary.bottom?b:Math.max(b,this._htPointBoundary.bottom);if(!c){var f=this._htOption.strokeWidth*(collie.Renderer.isRetinaDisplay()?2:1),g=this._htPointBoundary.right+2*f,h=this._htPointBoundary.bottom+2*f;this.set({width:g,height:h}),null!==this._oPaper&&this._oPaper.setSize(g,h)}},onDOMDraw:function(a){var b=a.element;if(!(this._aPointData.length<2)&&"undefined"!=typeof Raphael){var c=this.get(),d=c.strokeWidth,e=this.getDirty();null===this._oPaper?(this._oPaper=Raphael(b,c.width,c.height),this._oPaper.canvas.style.zIndex=10):e&&(e.width||e.height)&&this._oPaper.setSize(c.width,c.height),b.style.left=-(d/2)+"px",b.style.top=-(d/2)+"px",this._oPaper.clear();for(var f="M"+this._aPointData[0][0]+","+this._aPointData[0][1],g=1,h=this._aPointData.length;h>g;g++)f+=(this._aPointData[g][2]?"M":"L")+this._aPointData[g][0]+","+this._aPointData[g][1];!c.closePath||this._aPointData[0][0]===this._aPointData[this._aPointData.length-1][0]&&this._aPointData[0][1]===this._aPointData[this._aPointData.length-1][1]||(f+="L"+this._aPointData[0][0]+","+this._aPointData[0][1]);var i=this._oPaper.path(f+(c.closePath?"Z":""));i.transform("t"+d/2+","+d/2),c.fillImage?collie.ImageManager.getImage(c.fillImage,function(a){i.attr("fill","url('"+a.src+"')")}):c.fillColor&&i.attr("fill",c.fillColor),c.lineCap&&i.attr("stroke-linecap",c.lineCap),c.lineJoin&&i.attr("stroke-linejoin",c.lineJoin),null!==c.miterLimit&&i.attr("stroke-miterlimit",c.miterLimit),c.strokeColor&&i.attr("stroke",c.strokeColor),i.attr("stroke-width",d),c.dashArray&&i.attr("stroke-dasharray",c.dashArray)}},onCanvasDraw:function(a){if(!(this._aPointData.length<2)){var b=this.get(),c=a.context,d=collie.Renderer.isRetinaDisplay(),e=b.strokeWidth,f=d?2:1;if(c.save(),c.translate(a.x,a.y),d&&(e*=2),b.fillImage){var g=collie.ImageManager.getImage(b.fillImage);if(g){var h=c.createPattern(g,"repeat");c.fillStyle=h}else collie.ImageManager.getImage(b.fillImage,function(){this.setChanged()}.bind(this))}else b.fillColor&&(c.fillStyle=b.fillColor);if(b.strokeColor&&(c.strokeStyle=b.strokeColor),c.lineWidth=e,b.lineCap&&(c.lineCap=b.lineCap),b.lineJoin&&(c.lineJoin=b.lineJoin),b.miterLimit&&(c.miterLimit=b.miterLimit),b.dashArray){if(b.fillColor||b.fillImage){c.beginPath(),c.moveTo(this._aPointData[0][0]*f,this._aPointData[0][1]*f);for(var i=1,j=this._aPointData.length;j>i;i++)this._aPointData[i][2]?c.moveTo(this._aPointData[i][0]*f,this._aPointData[i][1]*f):c.lineTo(this._aPointData[i][0]*f,this._aPointData[i][1]*f);b.closePath&&c.closePath(),c.fill()}c.resetDashedLine()}c.beginPath(),c.moveTo(this._aPointData[0][0]*f,this._aPointData[0][1]*f);for(var i=1,j=this._aPointData.length;j>i;i++)this._aPointData[i][2]?c.moveTo(this._aPointData[i][0]*f,this._aPointData[i][1]*f):b.dashArray?c.dashedLine(this._aPointData[i-1][0]*f,this._aPointData[i-1][1]*f,this._aPointData[i][0]*f,this._aPointData[i][1]*f,collie.raphaelDashArray[b.dashArray],e):c.lineTo(this._aPointData[i][0]*f,this._aPointData[i][1]*f);b.dashArray&&b.closePath&&(this._aPointData[0][0]!==this._aPointData[this._aPointData.length-1][0]||this._aPointData[0][1]!==this._aPointData[this._aPointData.length-1][1])&&c.dashedLine(this._aPointData[i-1][0]*f,this._aPointData[i-1][1]*f,this._aPointData[0][0]*f,this._aPointData[0][1]*f,collie.raphaelDashArray[b.dashArray],e),b.closePath&&c.closePath(),b.dashArray||!b.fillColor&&!b.fillImage||c.fill(),b.strokeWidth&&c.stroke(),c.restore()}},toString:function(){return"Polyline"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Text=collie.Class({$init:function(){this._sText="",this.option({fontFamily:"Arial",fontWeight:"",fontSize:12,fontColor:"#000000",lineHeight:"auto",textAlign:"left",padding:"0 0 0 0",ellipsisMaxLine:0,ellipsisString:"...",useEllipsis:!1,useCache:!0},null,!0),this._elText=null,this._nTextWidth=0,this._nRatio=1,this._aCallbackTextWidth=[]},_initElement:function(){null===this._elText&&(this._elText=document.createElement("div"),this._elText.style.display="inline",this.getDrawing().getItemElement().appendChild(this._elText))},onCanvasDraw:function(a){this._nRatio="canvas"===this._sRenderingMode&&this._bRetinaDisplay?2:1,this._oContext=a.context;var b=this._getMaxWidth();this._oContext.font=this._getFontText(),this._oContext.fillStyle=this._htOption.fontColor,this._oContext.textBaseline="top",this._fillTextMultiline(this._wordWrap(b).split("\n"),a.x,a.y),this._triggerGetTextWidth()},onDOMDraw:function(a){this._initElement();var b=(this.getDrawing(),a.element),c=this._sText.replace(/\n/g,"<br />"),d=b.style;d.font=this._getFontText(),d.color=this._htOption.fontColor,d.padding=this._getPadding().replace(/ /g,"px ")+"px",d.width=this._getMaxWidth()+"px",d.height=this._getMaxHeight()+"px",d.lineHeight=this._getLineHeight()+"px",d.textAlign=this._htOption.textAlign,this._elText.innerHTML!=c&&(this._elText.innerHTML=c),this.unsetChanged(),this._getDOMTextWidth(),this._triggerGetTextWidth()},_getDOMTextWidth:function(){null!==this._elText&&(this._nTextWidth=this._elText.offsetWidth)},_getFontText:function(){return this._htOption.fontWeight+" "+this._htOption.fontSize*this._nRatio+"px "+this._htOption.fontFamily},_getLineHeight:function(){return"auto"===this._htOption.lineHeight?this._htOption.fontSize*this._nRatio:this._htOption.lineHeight*this._nRatio},_fillTextMultiline:function(a,b,c){var d=this._getPadding("left"),e=this._htOption.ellipsisMaxLine;this._nTextWidth=0;for(var f=0;f<a.length;f++){e&&f>=e-1&&a.length>e&&(a[f]=this._insertEllipsisText(a[f]),a.splice(f+1,a.length-(f+1)));var g=this._oContext.measureText(a[f]).width;"center"===this._htOption.textAlign?d=this._getMaxWidth()/2-g/2+this._getPadding("left"):"right"===this._htOption.textAlign&&(d=this._htOption.width*this._nRatio-this._getPadding("right")-g),this._oContext.fillText(a[f],b+d,c+this._getTopPosition(f+1)),this._nTextWidth=Math.max(this._nTextWidth,g)}},_getMaxWidth:function(){return this._htOption.width*this._nRatio-(this._getPadding("left")+this._getPadding("right"))},_getMaxHeight:function(){return this._htOption.height*this._nRatio-(this._getPadding("top")+this._getPadding("bottom"))},_getTopPosition:function(a){return this._getLineHeight()*(a-1)+this._getPadding("top")},_getPadding:function(a){for(var b=this._htOption.padding||"0 0 0 0",c=b.split(" "),d=0,e=c.length;e>d;d++)c[d]=parseInt(c[d],10)*this._nRatio;switch(a){case"top":return c[0];case"right":return c[1];case"bottom":return c[2];case"left":return c[3];default:return c.join(" ")}},_insertEllipsisText:function(a){for(var b=this._getMaxWidth(),c="",d=a.length;d>0;d--)if(c=a.substr(0,d)+this._htOption.ellipsisString,this._oContext.measureText(c).width<=b)return c;return a},_wordWrap:function(a,b){var c=b||this._sText,d=1;if(!c)return"";for(b=c.substr(0,1);this._oContext.measureText(b).width<=a;){if(d++,d>c.length)return b;if(b=c.substr(0,d),"\n"===c.substr(d-1,1))break}return d=Math.max(1,d-1),b=c.substr(0,d),"\n"===c.substr(d,1)&&d++,c.length>d&&(b+="\n"+this._wordWrap(a,c.substr(d))),b},text:function(a){return this._nTextWidth=0,this._aCallbackTextWidth=[],this._sText=a.toString(),this.setChanged(),this},getTextWidth:function(a){return a&&this._aCallbackTextWidth.push(a),this._nTextWidth?(this._triggerGetTextWidth(),this._nTextWidth/this._nRatio):void 0},_triggerGetTextWidth:function(){if(this._aCallbackTextWidth.length>0){for(var a=0,b=this._aCallbackTextWidth.length;b>a;a++)this._aCallbackTextWidth[a](this._nTextWidth/this._nRatio);this._aCallbackTextWidth=[]}},toString:function(){return"Text"+(this._htOption.name?" "+this._htOption.name:"")+" #"+this.getId()+(this.getImage()?"(image:"+this.getImage().src+")":"")}},collie.DisplayObject),collie.Animation=collie.Class({$init:function(a,b,c){this._nId=++collie.Animation._idx,this._bIsPlaying=!1,this._fCallback=a,this._oTimerList=null,this.option("useAutoStart",!0),this.option(("object"==typeof b?b:c)||{}),this.setDuration(b),this.setOptionEvent(c)},setOptionEvent:function(a){if(a)for(var b in a)0===b.toString().indexOf("on")&&this.attach(b.toString().replace(/^on/,"").toLowerCase(),a[b])},triggerCallback:function(a){if("function"!=typeof this._fCallback&&this._htOption.set){var b={};if(this._htOption.set instanceof Array)for(var c=0,d=this._htOption.set.length;d>c;c++)b[this._htOption.set[c]]=a.value instanceof Array?a.value[c]:a.value;else b[this._htOption.set]=a.value;if(this._fCallback instanceof Array)for(var e=0,d=this._fCallback.length;d>e;e++)this._fCallback[e].set(b);else this._fCallback.set(b)}else this._fCallback&&this._fCallback(a)},setDuration:function(a){this._nDuration=parseInt(a,10)},getDuration:function(){return this._nDuration},setTimerList:function(a){this._oTimerList=a,this._htOption.useAutoStart&&this.start()},getId:function(){return this._nId},run:function(){throw new Error("abstract method")},reset:function(){throw new Error("abstract method")},stop:function(a){this.isPlaying()&&(null!==this._oTimerList&&this._oTimerList.remove(this),this._bIsPlaying=!1,this.reset(),a||this.fireEvent("stop"))},pause:function(){this.isPlaying()&&(this._bIsPlaying=!1,this.fireEvent("pause"),null!==this._oTimerList&&this._oTimerList.remove(this))},start:function(){this.isPlaying()||(this._bIsPlaying=!0,null!==this._oTimerList&&this._oTimerList.add(this),this.fireEvent("start"))},isPlaying:function(){return this._bIsPlaying},complete:function(){this.isPlaying()&&(this._fCallbackComplete&&this._fCallbackComplete(),this.stop(!0),this.fireEvent("complete"))}},collie.Component),collie.Animation._idx=0,collie.AnimationTransition=collie.Class({$init:function(a,b,c){this.option({from:null,to:null,set:"",loop:1,effect:collie.Effect.linear}),this._htCallback={},this.option(c||{});var d=this.reset.bind(this);this.optionSetter("from",d),this.optionSetter("to",d),this._nCount=0,this._nCountCycle=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._bIsArrayValue=!1},start:function(){null===this._htOption.from&&"function"!=typeof this._fCallback&&this._setDefaultFromValues(),null===this._nFrameAtRunLastest&&this.reset(),this.constructor.$super.start.call(this)},_setDefaultFromValues:function(){var a=null;if(this._htOption.set){if(this._htOption.set instanceof Array){a=[];for(var b=0,c=this._htOption.set.length;c>b;b++)a.push(this._fCallback.get(this._htOption.set[b]))}else a=this._fCallback.get(this._htOption.set);this.option("from",a)}},reset:function(){if(this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nValue=this._htOption.from,this._bIsArrayValue=this._htOption.from instanceof Array,this._nCount=0,this._nCountCycle=0,this._bIsArrayValue){this._fEffect=[];for(var a=null,b=0,c=this._htOption.from.length;c>b;b++)a=this._htOption.effect instanceof Array?this._htOption.effect[b]:this._htOption.effect,this._fEffect[b]=a(this._htOption.from[b],this._htOption.to[b])}else this._fEffect=this._htOption.effect(this._htOption.from,this._htOption.to)},setValue:function(a){this._nValue=a},getValue:function(){return this._nValue},run:function(a,b){if(void 0===a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a)return this.reset(),void 0;if(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a,this._nRunningTime=0,b=0),this._nRunningTime+=b,this._nCount++,this._nRunningTime>=this._nDuration)if(this._nCountCycle++,!this._isEndValue()&&this._htOption.loop&&this._htOption.loop<=this._nCountCycle)this._setEndValue();else{if(this._htOption.loop&&!(this._htOption.loop>this._nCountCycle))return this.complete(),void 0;this.fireEvent("end"),this._nFrameAtRunLastest=a,this._nRunningTime=this._nRunningTime-this._nDuration,this._nValue=this._htOption.from,this._transitionValue(this._nRunningTime)}else this._nRunningTime>0&&this._transitionValue(this._nRunningTime);this._htCallback.timer=this,this._htCallback.frame=a,this._htCallback.duration=this._nDuration,this._htCallback.cycle=this._nCountCycle,this._htCallback.runningTime=this._nRunningTime,this._htCallback.from=this._htOption.from,this._htCallback.to=this._htOption.to,this._htCallback.value=this._nValue,this.triggerCallback(this._htCallback),this._nRunningTime>0&&(this._nFrameAtRunLastest=a)},_transitionValue:function(a){if(this._bIsArrayValue){this._nValue=[];for(var b=0,c=this._htOption.from.length;c>b;b++)this._nValue[b]=parseFloat(this._fEffect[b](Math.max(0,Math.min(1,a/this._nDuration))))}else this._nValue=parseFloat(this._fEffect(Math.max(0,Math.min(1,a/this._nDuration))))},_isEndValue:function(){if(this._bIsArrayValue){for(var a=0,b=this._htOption.to.length;b>a;a++)if(this._nValue[a]!==parseFloat(this._fEffect[a](1)))return!1;return!0}return this._nValue===parseFloat(this._fEffect(1))},_setEndValue:function(){if(this._bIsArrayValue)for(var a=0,b=this._htOption.to.length;b>a;a++)this._nValue[a]=parseFloat(this._fEffect[a](1));else this._nValue=parseFloat(this._fEffect(1))}},collie.Animation),collie.AnimationRepeat=collie.Class({$init:function(a,b,c){this.option({beforeDelay:0,afterDelay:0,loop:0,useRealTime:!0}),this.option(c||{}),this.reset(),this.setDuration(b),this._nFrameAtRunLastest=null},setDuration:function(a){a=parseInt(a,10),a<collie.Renderer.getDuration()&&(a=collie.Renderer.getDuration()),this._nDuration=a},reset:function(){this._nCount=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null,this._nBeforeDelay=this._htOption.beforeDelay},run:function(a,b){if(void 0===a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a)return this.reset(),void 0;null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a,this._nRunningTime=0,this._nRunLastestTime=0,b=0),this._nRunningTime+=b;var c=Math.max(1,Math.floor((this._nRunningTime-this._nRunLastestTime)/this._nDuration))-1;if(0===this._nCount&&this._nBeforeDelay)return this._nRunLastestTime+this._nBeforeDelay<=this._nRunningTime&&(this.reset(),this._nBeforeDelay=0),void 0;if(0===this._nRunningTime||this._nRunLastestTime+this._nDuration<=this._nRunningTime){if(this._nCount+=this._htOption.useRealTime?1+c:1,this._fCallback({timer:this,frame:a,duration:this._nDuration,count:this._nCount,skippedCount:c,runningTime:this._nRunningTime}),this._htOption.loop&&this._htOption.loop<=this._nCount)return this.complete(),void 0;this._nFrameAtRunLastest=a,this._nRunLastestTime=this._nRunningTime}}},collie.Animation),collie.AnimationCycle=collie.Class({$init:function(a,b,c){this._nFPS=null,this._htCallback={};var d=this._setterFPS.bind(this);this.optionSetter("valueSet",this._setterValueSet.bind(this)),this.optionSetter("to",d),this.optionSetter("from",d),this.option({delay:0,from:0,to:0,step:1,loop:0,set:"spriteX",useRealTime:!0,valueSet:null,start:null}),this.option(c||{}),this._nFrameAtRunLastest=null,this._nRunLastestTime=null,this._nRunningTime=null,this._nCountCycle=0,this._nCountCycleBefore=0,this.setDuration(b),this.reset()},reset:function(){this._nCount=0,this._nCountCycle=0,this._nCountCycleBefore=0,this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null,this._nValue=(null!==this._htOption.start?this._htOption.start:this._htOption.from)-this._htOption.step},_setterValueSet:function(){var a=this._htOption.valueSet;a&&a instanceof Array&&this.option({from:0,to:a.length-1,step:1})},_setterFPS:function(){if(null!==this._nFPS&&"undefined"!=typeof this._htOption.to&&"undefined"!=typeof this._htOption.from){var a=this._htOption.to-this._htOption.from+1;this._nDuration=Math.round(1e3/this._nFPS*a)}},setDuration:function(a){this._nDuration=parseInt(a,10),/fps/i.test(a)&&"undefined"!=typeof this._htOption.to&&"undefined"!=typeof this._htOption.from?(this._nFPS=parseInt(a,10),this._setterFPS()):this._nFPS=null},setValue:function(a){this._nValue=a},getValue:function(){return this._htOption.valueSet?this._htOption.valueSet[this._nValue]:this._nValue},run:function(a,b){if("undefined"==typeof a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a)return this.reset(),void 0;null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a,this._nRunLastestTime=0,this._nRunningTime=0,b=0),b||(b=0);var c=this._htOption,d=c.to-c.from;this._nTotalCount=d/c.step,this._nTerm=this._nDuration/this._nTotalCount,this._nRunningTime+=b;var e=c.useRealTime?Math.max(1,Math.floor((this._nRunningTime-this._nRunLastestTime)/this._nTerm))-1:0;if(0===this._nRunningTime||this._nRunLastestTime+this._nTerm<=this._nRunningTime){if(this._nCountCycleBefore!==this._nCountCycle&&this.fireEvent("end"),c.loop&&this._nCountCycle>=c.loop)return this.complete(),void 0;if(this._nValue===c.to&&(this._nValue=c.from-c.step),this._nValue+=c.step*(1+e),this._nCount+=1+e,this._nCountCycleBefore=this._nCountCycle,c.from<=c.to?this._nValue>=c.to:this._nValue<=c.to){var f=(this._nValue-c.to)/c.step,g=Math.ceil(f/(this._nTotalCount+1));f%=this._nTotalCount+1,f?(this._nCountCycle+=g,this._nValue=c.from+(f-1)*c.step):(this._nCountCycle+=1,this._nValue=c.to)}this._htCallback.timer=this,this._htCallback.frame=a,this._htCallback.duration=this._nDuration,this._htCallback.count=this._nCount,this._htCallback.skippedCount=e,this._htCallback.runningTime=this._nRunningTime,this._htCallback.value=this.getValue(),this._htCallback.cycle=this._nCountCycle,this._htCallback.step=c.step,this._htCallback.from=c.from,this._htCallback.to=c.to,this.triggerCallback(this._htCallback),this._nFrameAtRunLastest=a,this._nRunLastestTime=this._nRunningTime}}},collie.Animation),collie.AnimationDelay=collie.Class({$init:function(){this.reset()},reset:function(){this._nFrameAtRunLastest=null,this._nRunningTime=null,this._nRunLastestTime=null},run:function(a,b){return void 0===a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a?(this.reset(),void 0):(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a,this._nRunLastestTime=0,this._nRunningTime=0,b=0),this._nRunningTime+=b,this._nRunLastestTime+this._nDuration<=this._nRunningTime&&(this._fCallback&&this._fCallback({timer:this,frame:a,duration:this._nDuration,runningTime:this._nRunningTime}),this.complete()),void 0)}},collie.Animation),collie.AnimationTimeline=collie.Class({$init:function(a,b){if(this.option("loop",1),this.option(b||{}),this.setOptionEvent(b),this._htAnimations={},this._aTimeline=null,this._aRunningAnimation=null,this._nRunningTime=null,this._nCountCycle=0,a)for(var c=0,d=a.length;d>c;c++)this.addTimeline.apply(this,a[c]);this.reset()},add:function(a,b,c,d,e){var f;switch(b){case"delay":f=new collie.AnimationDelay(c,d,e);break;case"repeat":f=new collie.AnimationRepeat(c,d,e);break;case"transition":f=new collie.AnimationTransition(c,d,e);break;case"cycle":f=new collie.AnimationCycle(c,d,e);break;case"queue":f=new collie.AnimationQueue(c);break;default:if(!(b instanceof collie.Animation))throw new Error(b+" timer is not defined");f=b}return this._addTimeline(a,f),f},_addTimeline:function(a,b){a=parseInt(a,10),this._htAnimations[a]=this._htAnimations[a]||[],this._htAnimations[a].push(b),null!==this._aTimeline&&this.reset()},remove:function(a,b){if(a=parseInt(a,10),this._htAnimations&&this._htAnimations[a]){for(var c=0;c<this._htAnimations[a].length&&("undefined"!=typeof b&&b!==this._htAnimations[a][c]||(this._htAnimations[a][c].stop(),this._htAnimations[a].splice(c,1),c--,"undefined"==typeof b));c++);this._htAnimations[a].length<1&&(delete this._htAnimations[a],this._removeTimelineStartTime(a))}},_removeTimelineStartTime:function(a){if(this._aTimeline)for(var b=0,c=this._aTimeline.length;c>b;b++)if(this._aTimeline[b]===a){this._aTimeline.splice(b,1);break}},_initTimeline:function(){this._aTimeline=[],this._aRunningAnimation=[];for(var a in this._htAnimations)this._aTimeline.push(parseInt(a,10));this._aTimeline.sort(function(a,b){return a-b})},getAnimation:function(a){return a=parseInt(a,10),this._htAnimations&&this._htAnimations[a]?this._htAnimations[a]:!1},getRunningTime:function(){return this._nRunningTime||0},getCycle:function(){return this._nCountCycle||0},reset:function(){this._nFrameAtRunLastest=null,this._nRunningTime=null,this._aTimeline=null,this._aRunningAnimation=null,this._nCountCycle=0,this._initTimeline()},run:function(a,b){if(void 0===a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a)return this.reset(),void 0;if(null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a,this._nRunningTime=0,b=0),this._nRunningTime+=b,this._aTimeline.length>0)for(;this._aTimeline[0]<=this._nRunningTime;)for(var c=this._aTimeline.shift(),d=0,e=this._htAnimations[c].length;e>d;d++)this._aRunningAnimation.push(this._htAnimations[c][d]),this._htAnimations[c][d].start();if(this._aRunningAnimation.length>0)for(var d=0;d<this._aRunningAnimation.length;d++)this._aRunningAnimation[d]&&this._aRunningAnimation[d].run(a,b),this._aRunningAnimation[d]&&this._aRunningAnimation[d].isPlaying()||(this._aRunningAnimation[d]&&this._aRunningAnimation[d].reset(),this._aRunningAnimation.splice(d,1),d--,this._checkComplete())},_checkComplete:function(){this._aRunningAnimation.length<1&&this._aTimeline.length<1&&(this._nCountCycle++,this._htOption.loop&&this._htOption.loop<=this._nCountCycle?this.complete():(this.fireEvent("end"),this._nFrameAtRunLastest=null,this._nRunningTime=null,this._aTimeline=null,this._aRunningAnimation=null,this._initTimeline()))}},collie.Animation),collie.AnimationQueue=collie.Class({$init:function(a){this.option("loop",1),this.option(a||{}),this.setOptionEvent(a),this._aAnimations=[],this._fOnCompleteAnimation=this._onCompleteAnimation.bind(this),this.reset()},delay:function(a,b,c){return this._add(new collie.AnimationDelay(a,b,c)),this},repeat:function(a,b,c){return this._add(new collie.AnimationRepeat(a,b,c)),this},transition:function(a,b,c){return this._add(new collie.AnimationTransition(a,b,c)),this},cycle:function(a,b,c){return this._add(new collie.AnimationCycle(a,b,c)),this},getAnimation:function(a){return this._aAnimations[a]||!1},_add:function(a){a.attach("complete",this._fOnCompleteAnimation),this._aAnimations.push(a)},_onCompleteAnimation:function(){this.next()},next:function(){if(null===this._nAnimationIdx?this._nAnimationIdx=0:this._nAnimationIdx++,this._nAnimationIdx>=this._aAnimations.length){if(this._nCount++,this.fireEvent("end",{count:this._nCount}),this._htOption.loop&&!(this._htOption.loop>this._nCount))return this.complete(),void 0;this._nAnimationIdx=0}this._aAnimations[this._nAnimationIdx].stop(),this._aAnimations[this._nAnimationIdx].start()},reset:function(){this._nFrameAtRunLastest=null,this._nAnimationIdx=null,this._nCount=0},removeAll:function(){this._aAnimations=[],this.reset()},removeAfter:function(){if(this._nAnimationIdx+1<=this._aAnimations.length-1){var a=this._aAnimations.length-(this._nAnimationIdx+1);this._aAnimations.splice(this._nAnimationIdx+1,a)}},run:function(a,b){if(!(this._aAnimations.length<1)){if(void 0===a&&(a=collie.Renderer.getInfo().frame),this._nFrameAtRunLastest>a)return this.reset(),void 0;null===this._nFrameAtRunLastest&&(this._nFrameAtRunLastest=a),null===this._nAnimationIdx&&this.next(),this._aAnimations[this._nAnimationIdx].run(a,b)}}},collie.Animation),collie.TimerList=collie.Class({$init:function(){this._aList=[]},add:function(a){this._aList.unshift(a)},remove:function(a){for(var b=0,c=this._aList.length;c>b;b++)if(this._aList[b]===a){this._aList.splice(b,1);break}},removeAll:function(){this._aList=[]},stopAll:function(){for(var a=this._aList.length-1;a>=0;a--)this._aList[a].stop()},run:function(a,b){for(var c=this._aList.length-1;c>=0;c--)this._aList[c]&&(this._aList[c].isPlaying()?this._aList[c].run(a,b):this._aList.splice(c,1))}}),collie.Timer=collie.Timer||new(collie.Class({$init:function(){this._oList=new collie.TimerList},run:function(a,b){this._oList.run(a,b)},stopAll:function(){this._oList.stopAll()},removeAll:function(){this._oList.removeAll()},queue:function(a){var b=new collie.AnimationQueue(a);return b.setTimerList(this._oList),b},repeat:function(a,b,c){var d=new collie.AnimationRepeat(a,b,c);return d.setTimerList(this._oList),d},transition:function(a,b,c){var d=new collie.AnimationTransition(a,b,c);return d.setTimerList(this._oList),d},cycle:function(a,b,c){var d=new collie.AnimationCycle(a,b,c);return d.setTimerList(this._oList),d},delay:function(a,b,c){var d=new collie.AnimationDelay(a,b,c);return d.setTimerList(this._oList),d},timeline:function(a,b){var c=new collie.AnimationTimeline(a,b);return c.setTimerList(this._oList),c}})),collie.Renderer=collie.Renderer||new(collie.Class({DEFAULT_FPS:"60fps",RETINA_DISPLAY:!1,DEBUG_USE_DELAY:!1,DEBUG_MAX_DELAY:200,DEBUG_RENDERING_MODE:"auto",USE_AUTO_PAUSE:!0,DELAY_LIMIT:3e3,$init:function(){this._sVisibilityChange=this._getNamePageVisibility(),this._bPlaying=!1,this._bPause=!1,this._nFPS=0,this._nDuration=0,this._nCurrentFrame=0,this._nSkippedFrame=0,this._nBeforeFrameTime=null,this._nBeforeRenderingTime=0,this._aLayerList=[],this._fRender=this._render.bind(this),this._fCallback=null,this._htCallback={},this._elContainer=document.createElement("div"),this._elContainer.className="_collie_container",this._elContainer.style.position="relative",this._elContainer.style.overflow="hidden",this._elParent=null,this._nDebugDelayedTime=0,this._oRenderingTimer=null,this._bLoaded=!1,this._sRenderingMode=null,this._bUseRetinaDisplay=null,this._htEventStatus={},this._htPosition={},this._bIsPreventDefault=!0,this._htDeviceInfo=collie.util.getDeviceInfo(),this._fOnChangeVisibility=this._onChangeVisibility.bind(this),this._fOnPageShow=this._onPageShow.bind(this),this._fOnPageHide=this._onPageHide.bind(this),this._fRefresh=this.refresh.bind(this)},_onPageShow:function(){this.USE_AUTO_PAUSE&&!this.isPlaying()&&this._bPause&&this.resume()},_onPageHide:function(){this.USE_AUTO_PAUSE&&this.isPlaying()&&this.pause()},_onChangeVisibility:function(){if(this.USE_AUTO_PAUSE){var a=document.visibilityState||document.webkitVisibilityState||document.mozVisibilityState;"hidden"===a?this.pause():"visible"===a&&this.resume()}},refresh:function(){null!==this._elParent&&(this._htPosition=collie.util.getPosition(this._elParent))},getPosition:function(){return this._bLoaded?this._htPosition:!1},addLayer:function(a){if(!(a&&"type"in a&&"layer"===a.type))throw new Error("oLayer is not Layer instnace");for(var b=0,c=this._aLayerList.length;c>b;b++)if(this._aLayerList[b]===a)return;this._aLayerList.push(a),this._bLoaded&&(a.load(this._elContainer,this._aLayerList.length),this.resetLayerEvent())},removeLayer:function(a){for(var b=0,c=this._aLayerList.length;c>b;b++)if(this._aLayerList[b]===a)return this._aLayerList[b].unload(),this._aLayerList.splice(b,1),void 0},removeAllLayer:function(){for(var a=this._aLayerList.length-1;a>=0;a--)this._aLayerList[a].unload();this._aLayerList=[]},getLayers:function(){return this._aLayerList},resetLayerEvent:function(){for(var a=0,b=this._aLayerList.length;b>a;a++)this._aLayerList[a].detachEvent();for(var a=this._aLayerList.length-1;a>=0;a--)this._aLayerList[a].attachEvent()},getElement:function(){return this._elContainer},getDuration:function(){return this._nDuration},getInfo:function(){return this._htCallback.frame=this._nCurrentFrame,this._htCallback.skippedFrame=this._nSkippedFrame,this._htCallback.fps=this._nFPS,this._htCallback.duration=this._nDuration,this._htCallback.renderingTime=this._nBeforeRenderingTime,this._htCallback.beforeFrameTime=this._nBeforeFrameTime,this._htCallback},getRenderingMode:function(){if(null===this._sRenderingMode){var a=collie.util.getDeviceInfo();this._sRenderingMode=this.DEBUG_RENDERING_MODE,this._sRenderingMode&&"auto"!==this._sRenderingMode||(this._sRenderingMode=a.android&&!a.chrome&&(a.android<4.2&&a.android>=3||a.android<2.2)||!a.supportCanvas||a.ios&&a.ios<5?"dom":"canvas"),a.supportCanvas||(this._sRenderingMode="dom")}return this._sRenderingMode},setRenderingMode:function(a){this.DEBUG_RENDERING_MODE=a.toString().toLowerCase(),this._sRenderingMode=null},isRetinaDisplay:function(){if(null===this._bUseRetinaDisplay){this._bUseRetinaDisplay="auto"!==this.RETINA_DISPLAY?this.RETINA_DISPLAY:window.devicePixelRatio>=2&&(!collie.util.getDeviceInfo().android||collie.util.getDeviceInfo().android>=4);var a=collie.util.getDeviceInfo();
a.ie&&a.ie<9&&(this._bUseRetinaDisplay=!1)}return this._bUseRetinaDisplay},setRetinaDisplay:function(a){this.RETINA_DISPLAY=a,this._bUseRetinaDisplay=null},_getNameAnimationFrame:function(a){return"undefined"!=typeof window.requestAnimationFrame?a?"cancelAnimationFrame":"requestAnimationFrame":"undefined"!=typeof window.webkitRequestAnimationFrame?a?"webkitCancelAnimationFrame":"webkitRequestAnimationFrame":"undefined"!=typeof window.msRequestAnimationFrame?a?"msCancelAnimationFrame":"msRequestAnimationFrame":"undefined"!=typeof window.mozRequestAnimationFrame?a?"mozCancelAnimationFrame":"mozRequestAnimationFrame":"undefined"!=typeof window.oRequestAnimationFrame?a?"oCancelAnimationFrame":"oRequestAnimationFrame":!1},_getNamePageVisibility:function(){return"hidden"in document?"visibilitychange":"webkitHidden"in document?"webkitvisibilitychange":"mozHidden"in document?"mozvisibilitychange":!1},load:function(a){if(this.unload(),this._bLoaded=!0,"string"==typeof a&&(a=document.getElementById(a)),this._elParent=a,this._elParent.appendChild(this._elContainer),this.refresh(),this._aLayerList.length){for(var b=0,c=this._aLayerList.length;c>b;b++)this._aLayerList[b].load(this._elContainer,b);for(var b=this._aLayerList.length-1;b>=0;b--)this._aLayerList[b].attachEvent()}this._sVisibilityChange?collie.util.addEventListener(document,this._sVisibilityChange,this._fOnChangeVisibility):this._htDeviceInfo.desktop||(collie.util.addEventListener(window,"pageshow",this._fOnPageShow),collie.util.addEventListener(window,"pagehide",this._fOnPageHide)),collie.util.addEventListener(window,"resize",this._fRefresh)},unload:function(){if(this._bLoaded){for(var a=0,b=this._aLayerList.length;b>a;a++)this._aLayerList[a].unload();this._elParent.removeChild(this._elContainer),this._elParent=null,this._bLoaded=!1,this._sVisibilityChange?collie.util.removeEventListener(document,this._sVisibilityChange,this._fOnChangeVisibility):this._htDeviceInfo.desktop||(collie.util.removeEventListener(window,"pageshow",this._fOnPageShow),collie.util.removeEventListener(window,"pagehide",this._fOnPageHide)),collie.util.removeEventListener(window,"resize",this._fRefresh)}},start:function(a,b){this._bPlaying||(a=a||this.DEFAULT_FPS,this._nDuration=/fps$/i.test(a)?1e3/parseInt(a,10):Math.max(16,a),this._fCallback=b||null,this._bPlaying=!0,this._nDuration<17?(this._sRequestAnimationFrameName=this._getNameAnimationFrame(),this._sCancelAnimationFrameName=this._getNameAnimationFrame(!0)):(this._sRequestAnimationFrameName=!1,this._sCancelAnimationFrameName=!1),this.fireEvent("start"),this._trigger(0))},_trigger:function(a){!this._sVisibilityChange&&this.USE_AUTO_PAUSE&&window.screenTop<-3e4&&this.pause(),a="undefined"==typeof a?0:parseInt(a,10),this._oRenderingTimer=this._sRequestAnimationFrameName!==!1&&!this.DEBUG_USE_DELAY&&this.USE_AUTO_PAUSE?window[this._sRequestAnimationFrameName](this._fRender):setTimeout(this._fRender,a)},_render:function(a,b){if(this._bPlaying||b){var c=this._getDate(),d=0,e=1;if(null!==this._nBeforeFrameTime){if(d=c-this._nBeforeFrameTime,e=a||Math.max(1,Math.round(d/this._nDuration)),d>this.DELAY_LIMIT)return this.pause(),void 0;this._sRequestAnimationFrameName!==!1&&this.USE_AUTO_PAUSE&&(a=0,e=1),this._nSkippedFrame+=Math.max(0,e-1),this._nFPS=Math.round(1e3/(c-this._nBeforeFrameTime))}this._nCurrentFrame+=e;var f=this.getInfo();if(null!==this._fCallback&&this._fCallback(f)===!1||this.fireEvent("process",f)===!1)this.stop();else{collie.Timer.run(this._nCurrentFrame,d),this._update(d);var g=0;this.DEBUG_USE_DELAY&&(g=Math.round(Math.random()*this.DEBUG_MAX_DELAY),this._nDebugDelayedTime+=g),this._nBeforeRenderingTime=this._getDate()-c,this._nBeforeFrameTime=c,this._bPlaying&&this._trigger(Math.max(0,this._nDuration-this._nBeforeRenderingTime+2*g))}}},draw:function(a){this._fRender(a,!0)},_getDate:function(){return+new Date+(this.DEBUG_USE_DELAY?this._nDebugDelayedTime:0)},stop:function(){this._bPlaying&&(this._bPlaying=!1,this._resetTimer(),this.fireEvent("stop",this.getInfo()),this._sRenderingMode=null,this._bUseRetinaDisplay=null,this._fCallback=null,this._nCurrentFrame=0,this._nBeforeRenderingTime=0,this._nSkippedFrame=0,this._nBeforeFrameTime=null)},_resetTimer:function(){null!==this._oRenderingTimer&&(this._sCancelAnimationFrameName!==!1?window[this._sCancelAnimationFrameName](this._oRenderingTimer):clearTimeout(this._oRenderingTimer),window.tempTimer=window.tempTimer||[],window.tempTimer.push(this._oRenderingTimer),this._oRenderingTimer=null)},pause:function(){this._bPlaying&&(this._bPlaying=!1,this._bPause=!0,this.fireEvent("pause",this.getInfo()),this._resetTimer())},resume:function(){this._bPause&&(this._nBeforeFrameTime=this._getDate(),this._nBeforeRenderingTime=0,this._bPlaying=!0,this._bPause=!1,this.fireEvent("resume",this.getInfo()),this._trigger(0))},isPlaying:function(){return this._bPlaying},_update:function(a){for(var b=0,c=this._aLayerList.length;c>b;b++)this._aLayerList[b].update(a)},setEventStatus:function(a,b){this._htEventStatus={type:a,firedOnTarget:b}},isStopEvent:function(a){return"click"===a&&(a="mouseup"),a===this._htEventStatus.type&&this._htEventStatus.firedOnTarget},getEventStatus:function(){return this._htEventStatus},setPreventDefault:function(a){this._bIsPreventDefault=!!a},isPreventDefault:function(){return this._bIsPreventDefault},resize:function(a,b,c){for(var d=0,e=this._aLayerList.length;e>d;d++)this._aLayerList[d].resize(a,b,c)}},collie.Component));